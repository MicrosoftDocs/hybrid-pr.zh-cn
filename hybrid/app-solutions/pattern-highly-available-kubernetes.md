---
title: 使用 Azure 和 Azure Stack Hub 的高可用性 Kubernetes 模式
description: 了解 Kubernetes 群集解决方案如何使用 Azure 和 Azure Stack Hub 提供高可用性。
author: BryanLa
ms.topic: article
ms.date: 12/03/2020
ms.author: bryanla
ms.reviewer: bryanla
ms.lastreviewed: 12/03/2020
ms.openlocfilehash: 454cc0a0531882b7a8ec050a461420ce13eebcfe
ms.sourcegitcommit: df7e3e6423c3d4e8a42dae3d1acfba1d55057258
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 12/09/2020
ms.locfileid: "96911998"
---
# <a name="high-availability-kubernetes-cluster-pattern"></a><span data-ttu-id="fb654-103">高可用性 Kubernetes 群集模式</span><span class="sxs-lookup"><span data-stu-id="fb654-103">High availability Kubernetes cluster pattern</span></span>

<span data-ttu-id="fb654-104">本文介绍如何在 Azure Stack Hub 上使用 Azure Kubernetes 服务 (AKS) 引擎构建和运行基于 Kubernetes 的高可用性基础结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-104">This article describes how to architect and operate a highly available Kubernetes-based infrastructure using Azure Kubernetes Service (AKS) Engine on Azure Stack Hub.</span></span> <span data-ttu-id="fb654-105">对于在高度受限和受监管的环境中具有关键工作负载的组织来说，这种情形很常见。</span><span class="sxs-lookup"><span data-stu-id="fb654-105">This scenario is common for organizations with critical workloads in highly restricted and regulated environments.</span></span> <span data-ttu-id="fb654-106">金融、国防和政府等领域的组织。</span><span class="sxs-lookup"><span data-stu-id="fb654-106">Organizations in domains such as finance, defense, and government.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="fb654-107">上下文和问题</span><span class="sxs-lookup"><span data-stu-id="fb654-107">Context and problem</span></span>

<span data-ttu-id="fb654-108">许多组织正在开发利用先进服务和技术（如 Kubernetes）的云原生解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-108">Many organizations are developing cloud-native solutions that leverage state-of-the-art services and technologies like Kubernetes.</span></span> <span data-ttu-id="fb654-109">虽然 Azure 在世界上大多数区域都提供数据中心，但有时也存在一些边缘用例和场景，其中业务关键型应用程序必须在特定位置运行。</span><span class="sxs-lookup"><span data-stu-id="fb654-109">Although Azure provides datacenters in most regions of the world, sometimes there are edge use-cases and scenarios where business critical applications must run in a specific location.</span></span> <span data-ttu-id="fb654-110">考虑因素包括：</span><span class="sxs-lookup"><span data-stu-id="fb654-110">Considerations include:</span></span>

- <span data-ttu-id="fb654-111">位置敏感性</span><span class="sxs-lookup"><span data-stu-id="fb654-111">Location sensitivity</span></span>
- <span data-ttu-id="fb654-112">应用程序和本地系统之间的延迟</span><span class="sxs-lookup"><span data-stu-id="fb654-112">Latency between the application and on-premises systems</span></span>
- <span data-ttu-id="fb654-113">带宽节省</span><span class="sxs-lookup"><span data-stu-id="fb654-113">Bandwidth conservation</span></span>
- <span data-ttu-id="fb654-114">连接</span><span class="sxs-lookup"><span data-stu-id="fb654-114">Connectivity</span></span>
- <span data-ttu-id="fb654-115">法规或法定要求</span><span class="sxs-lookup"><span data-stu-id="fb654-115">Regulatory or statutory requirements</span></span>

<span data-ttu-id="fb654-116">Azure 与 Azure Stack Hub 结合使用即可解决这其中绝大部分问题。</span><span class="sxs-lookup"><span data-stu-id="fb654-116">Azure, in combination with Azure Stack Hub, addresses most of these concerns.</span></span> <span data-ttu-id="fb654-117">下面介绍了成功实现在 Azure Stack Hub 上运行 Kubernetes 的一系列选项、决策和注意事项。</span><span class="sxs-lookup"><span data-stu-id="fb654-117">A broad set of options, decisions, and considerations for a successful implementation of Kubernetes running on Azure Stack Hub is described below.</span></span>

## <a name="solution"></a><span data-ttu-id="fb654-118">解决方案</span><span class="sxs-lookup"><span data-stu-id="fb654-118">Solution</span></span>

<span data-ttu-id="fb654-119">此模式假设必须处理一组严格的约束。</span><span class="sxs-lookup"><span data-stu-id="fb654-119">This pattern assumes that we have to deal with a strict set of constraints.</span></span> <span data-ttu-id="fb654-120">应用程序必须在本地运行，并且所有个人数据都不得访问公有云服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-120">The application must run on-premises and all personal data must not reach public cloud services.</span></span> <span data-ttu-id="fb654-121">监视和其他非 PII 数据可以发送到 Azure 并在其中进行处理。</span><span class="sxs-lookup"><span data-stu-id="fb654-121">Monitoring and other non-PII data can be sent to Azure and be processed there.</span></span> <span data-ttu-id="fb654-122">公共容器注册表等外部服务可以进行访问，但可能会通过防火墙或代理服务器进行筛选。</span><span class="sxs-lookup"><span data-stu-id="fb654-122">External services like a public Container Registry or others can be accessed but might be filtered through a firewall or proxy server.</span></span>

<span data-ttu-id="fb654-123">此处所示的示例应用程序（基于 [Azure Kubernetes 服务研讨会](/learn/modules/aks-workshop/)）旨在尽可能使用 Kubernetes 原生解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-123">The sample application shown here (based on [Azure Kubernetes Service Workshop](/learn/modules/aks-workshop/)) is designed to use Kubernetes-native solutions whenever possible.</span></span> <span data-ttu-id="fb654-124">此设计可以避免供应商锁定，而不是使用平台原生服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-124">This design avoids vendor lock-in, instead of using platform-native services.</span></span> <span data-ttu-id="fb654-125">例如，应用程序使用自承载 MongoDB 数据库后端，而不是 PaaS 服务或外部数据库服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-125">As an example, the application uses a self-hosted MongoDB database backend instead of a PaaS service or external database service.</span></span>

<span data-ttu-id="fb654-126">[![应用程序模式混合](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="fb654-126">[![Application Pattern Hybrid](media/pattern-highly-available-kubernetes/application-architecture.png)](media/pattern-highly-available-kubernetes/application-architecture.png#lightbox)</span></span>

<span data-ttu-id="fb654-127">上图说明了在 Azure Stack Hub 的 Kubernetes 上运行的示例应用程序的应用程序体系结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-127">The preceding diagram illustrates the application architecture of the sample application running on Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="fb654-128">该应用由几个组件组成，包括：</span><span class="sxs-lookup"><span data-stu-id="fb654-128">The app consists of several components, including:</span></span>

 1) <span data-ttu-id="fb654-129">Azure Stack Hub 上基于 AKS 引擎的 Kubernetes 群集。</span><span class="sxs-lookup"><span data-stu-id="fb654-129">An AKS Engine based Kubernetes cluster on Azure Stack Hub.</span></span>
 2) <span data-ttu-id="fb654-130">[cert-manager](https://www.jetstack.io/cert-manager/)，为 Kubernetes 中的证书管理提供了一套工具，用于自动从 Let's Encrypt 请求证书。</span><span class="sxs-lookup"><span data-stu-id="fb654-130">[cert-manager](https://www.jetstack.io/cert-manager/), which provides a suite of tools for certificate management in Kubernetes, used to automatically request certificates from Let's Encrypt.</span></span>
 3) <span data-ttu-id="fb654-131">Kubernetes 命名空间，包含前端 (ratings-web)、API (ratings-api) 和数据库 (ratings-mongodb) 的应用程序组件。</span><span class="sxs-lookup"><span data-stu-id="fb654-131">A Kubernetes namespace that contains the application components for the front end (ratings-web), api (ratings-api), and database (ratings-mongodb).</span></span>
 4) <span data-ttu-id="fb654-132">将 HTTP/HTTPS 流量路由到 Kubernetes 群集中的终结点的入口控制器。</span><span class="sxs-lookup"><span data-stu-id="fb654-132">The Ingress Controller that routes HTTP/HTTPS traffic to endpoints within the Kubernetes cluster.</span></span>

<span data-ttu-id="fb654-133">示例应用程序用于说明应用程序体系结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-133">The sample application is used to illustrate the application architecture.</span></span> <span data-ttu-id="fb654-134">所有组件都是示例。</span><span class="sxs-lookup"><span data-stu-id="fb654-134">All components are examples.</span></span> <span data-ttu-id="fb654-135">该体系结构只包含一种应用程序部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-135">The architecture contains only a single application deployment.</span></span> <span data-ttu-id="fb654-136">为实现高可用性 (HA)，我们将在两个不同的 Azure Stack Hub 实例上至少运行两次部署，它们可以在相同的位置运行，也可以在两个（或多个）不同的位置运行：</span><span class="sxs-lookup"><span data-stu-id="fb654-136">To achieve high availability (HA), we'll run the deployment at least twice on two different Azure Stack Hub instances - they can run either in the same location or in two (or more) different sites:</span></span>

![基础结构体系结构](media/pattern-highly-available-kubernetes/aks-azure-architecture.png)

<span data-ttu-id="fb654-138">Azure 容器注册表、Azure Monitor 等服务托管在 Azure 中的 Azure Stack Hub 之外或本地。</span><span class="sxs-lookup"><span data-stu-id="fb654-138">Services like Azure Container Registry, Azure Monitor, and others, are hosted outside Azure Stack Hub in Azure or on-premises.</span></span> <span data-ttu-id="fb654-139">这种混合设计可保护解决方案不受单个 Azure Stack Hub 实例中断的影响。</span><span class="sxs-lookup"><span data-stu-id="fb654-139">This hybrid design protects the solution against outage of a single Azure Stack Hub instance.</span></span>

## <a name="components"></a><span data-ttu-id="fb654-140">组件</span><span class="sxs-lookup"><span data-stu-id="fb654-140">Components</span></span>

<span data-ttu-id="fb654-141">整体体系结构包括以下组件：</span><span class="sxs-lookup"><span data-stu-id="fb654-141">The overall architecture consists of the following components:</span></span>

<span data-ttu-id="fb654-142">Azure Stack Hub 是 Azure 的扩展，它通过在数据中心提供 Azure 服务，可以在本地环境中运行工作负载。</span><span class="sxs-lookup"><span data-stu-id="fb654-142">**Azure Stack Hub** is an extension of Azure that can run workloads in an on-premises environment by providing Azure services in your datacenter.</span></span> <span data-ttu-id="fb654-143">请转到·[Azure Stack Hub 概述](/azure-stack/operator/azure-stack-overview)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-143">Go to [Azure Stack Hub overview](/azure-stack/operator/azure-stack-overview) to learn more.</span></span>

<span data-ttu-id="fb654-144">Azure Kubernetes 服务引擎（AKS 引擎）是托管 Kubernetes 服务产品 Azure Kubernetes 服务 (AKS) 背后的引擎，Azure 中现已提供该产品。</span><span class="sxs-lookup"><span data-stu-id="fb654-144">**Azure Kubernetes Service Engine (AKS Engine)** is the engine behind the managed Kubernetes service offering, Azure Kubernetes Service (AKS), that is available in Azure today.</span></span> <span data-ttu-id="fb654-145">对于 Azure Stack Hub，AKS 引擎允许我们使用 Azure Stack Hub 的 IaaS 功能部署、扩展和升级功能齐全的自托管 Kubernetes 群集。</span><span class="sxs-lookup"><span data-stu-id="fb654-145">For Azure Stack Hub, AKS Engine allows us to deploy, scale, and upgrade fully featured, self-managed Kubernetes clusters using Azure Stack Hub's IaaS capabilities.</span></span> <span data-ttu-id="fb654-146">请转到·[AKS 引擎概述](https://github.com/Azure/aks-engine)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-146">Go to [AKS Engine Overview](https://github.com/Azure/aks-engine) to learn more.</span></span>

<span data-ttu-id="fb654-147">若要详细了解 Azure 上的 AKS 引擎与 Azure Stack Hub 上的 AKS 引擎之间的差异，请转到[已知问题和限制](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations)。</span><span class="sxs-lookup"><span data-stu-id="fb654-147">Go to [Known Issues and Limitations](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#known-issues-and-limitations) to learn more about the differences between AKS Engine on Azure and AKS Engine on Azure Stack Hub.</span></span>

<span data-ttu-id="fb654-148">Azure 虚拟网络 (VNet) 用于在每个 Azure Stack Hub 上为托管 Kubernetes 群集基础结构的虚拟机 (VM) 提供网络基础结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-148">**Azure Virtual Network (VNet)** is used to provide the network infrastructure on each Azure Stack Hub for the Virtual Machines (VMs) hosting the Kubernetes cluster infrastructure.</span></span>

<span data-ttu-id="fb654-149">Azure 负载均衡器用于 Kubernetes API 终结点和 Nginx 入口控制器。</span><span class="sxs-lookup"><span data-stu-id="fb654-149">**Azure Load Balancer** is used for the Kubernetes API Endpoint and the Nginx Ingress Controller.</span></span> <span data-ttu-id="fb654-150">负载均衡器将外部（例如 Internet）流量路由到提供特定服务的节点和 VM。</span><span class="sxs-lookup"><span data-stu-id="fb654-150">The load balancer routes external (for example, Internet) traffic to nodes and VMs offering a specific service.</span></span>

<span data-ttu-id="fb654-151">Azure 容器注册表 (ACR) 用于存储部署到群集中的 Docker 映像和 Helm 图表。</span><span class="sxs-lookup"><span data-stu-id="fb654-151">**Azure Container Registry (ACR)** is used to store private Docker images and Helm charts, which are deployed to the cluster.</span></span> <span data-ttu-id="fb654-152">AKS 引擎可以使用 Azure AD 标识对容器注册表进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="fb654-152">AKS Engine can authenticate with the Container Registry using an Azure AD identity.</span></span> <span data-ttu-id="fb654-153">Kubernetes 不需要 ACR。</span><span class="sxs-lookup"><span data-stu-id="fb654-153">Kubernetes doesn't require ACR.</span></span> <span data-ttu-id="fb654-154">可以使用其他容器注册表，例如 Docker 中心。</span><span class="sxs-lookup"><span data-stu-id="fb654-154">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="fb654-155">Azure Repos 是一组版本控制工具，可以用来管理代码。</span><span class="sxs-lookup"><span data-stu-id="fb654-155">**Azure Repos** is a set of version control tools that you can use to manage your code.</span></span> <span data-ttu-id="fb654-156">还可以使用 GitHub 或其他基于 Git 的存储库。</span><span class="sxs-lookup"><span data-stu-id="fb654-156">You can also use GitHub or other git-based repositories.</span></span> <span data-ttu-id="fb654-157">请转到·[Azure Repos 概述](/azure/devops/repos/get-started/what-is-repos)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-157">Go to [Azure Repos Overview](/azure/devops/repos/get-started/what-is-repos) to learn more.</span></span>

<span data-ttu-id="fb654-158">Azure Pipelines 是 Azure DevOps Services 的一部分，可运行自动化的生成、测试和部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-158">**Azure Pipelines** is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="fb654-159">也可以使用 Jenkins 等第三方 CI/CD 解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-159">You can also use third-party CI/CD solutions such as Jenkins.</span></span> <span data-ttu-id="fb654-160">请转到·[Azure Pipelines 概述](/azure/devops/pipelines/get-started/what-is-azure-pipelines)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-160">Go to [Azure Pipeline Overview](/azure/devops/pipelines/get-started/what-is-azure-pipelines) to learn more.</span></span>

<span data-ttu-id="fb654-161">Azure Monitor 收集并存储指标和日志，包括解决方案中 Azure 服务的平台指标，以及应用程序遥测数据。</span><span class="sxs-lookup"><span data-stu-id="fb654-161">**Azure Monitor** collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="fb654-162">使用此数据可以监视应用程序、设置警报和仪表板，以及针对故障执行根本原因分析。</span><span class="sxs-lookup"><span data-stu-id="fb654-162">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="fb654-163">Azure Monitor 与 Kubernetes 相集成，可以从控制器、节点和容器收集指标，并可以收集容器日志和主节点日志。</span><span class="sxs-lookup"><span data-stu-id="fb654-163">Azure Monitor integrates with Kubernetes to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span> <span data-ttu-id="fb654-164">请转到·[Azure Monitor 概述](/azure/azure-monitor/overview)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-164">Go to [Azure Monitor Overview](/azure/azure-monitor/overview) to learn more.</span></span>

<span data-ttu-id="fb654-165">Azure 流量管理器是一种基于 DNS 的流量负载均衡器，借助它可以跨不同 Azure 区域或 Azure Stack Hub 部署以最佳方式向服务分发流量。</span><span class="sxs-lookup"><span data-stu-id="fb654-165">**Azure Traffic Manager** is a DNS-based traffic load balancer that enables you to distribute traffic optimally to services across different Azure regions or Azure Stack Hub deployments.</span></span> <span data-ttu-id="fb654-166">流量管理器还提供高可用性和响应能力。</span><span class="sxs-lookup"><span data-stu-id="fb654-166">Traffic Manager also provides high availability and responsiveness.</span></span> <span data-ttu-id="fb654-167">应用程序终结点必须可从外部访问。</span><span class="sxs-lookup"><span data-stu-id="fb654-167">The application endpoints must be accessible from the outside.</span></span> <span data-ttu-id="fb654-168">还有其他本地解决方案可用。</span><span class="sxs-lookup"><span data-stu-id="fb654-168">There are other on-premises solutions available as well.</span></span>

<span data-ttu-id="fb654-169">Kubernetes 入口控制器会向 Kubernetes 群集中的服务公开 HTTP(S) 路由。</span><span class="sxs-lookup"><span data-stu-id="fb654-169">**Kubernetes Ingress Controller** exposes HTTP(S) routes to services in a Kubernetes cluster.</span></span> <span data-ttu-id="fb654-170">可以使用 Nginx 或任何适合的入口控制器来实现此目的。</span><span class="sxs-lookup"><span data-stu-id="fb654-170">Nginx or any suitable ingress controller can be used for this purpose.</span></span>

<span data-ttu-id="fb654-171">Helm 是 Kubernetes 部署的包管理器，提供了一种将不同 Kubernetes 对象（如部署、服务、机密）捆绑到一个“图表”中的方法。</span><span class="sxs-lookup"><span data-stu-id="fb654-171">**Helm** is a package manager for Kubernetes deployment, providing a way to bundle different Kubernetes objects like Deployments, Services, Secrets, into a single "chart".</span></span> <span data-ttu-id="fb654-172">可以发布、部署、控制版本管理和更新图表对象。</span><span class="sxs-lookup"><span data-stu-id="fb654-172">You can publish, deploy, control version management, and update a chart  object.</span></span> <span data-ttu-id="fb654-173">Azure 容器注册表可以用作存储打包的 Helm 图表的存储库。</span><span class="sxs-lookup"><span data-stu-id="fb654-173">Azure Container Registry can be used as a repository to store packaged Helm Charts.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="fb654-174">设计注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-174">Design considerations</span></span>

<span data-ttu-id="fb654-175">此模式遵循一些大致注意事项，将在本文的下面部分中进行详细说明：</span><span class="sxs-lookup"><span data-stu-id="fb654-175">This pattern follows a few high-level considerations explained in more detail in the next sections of this article:</span></span>

- <span data-ttu-id="fb654-176">该应用程序使用 Kubernetes 原生解决方案，避免供应商锁定。</span><span class="sxs-lookup"><span data-stu-id="fb654-176">The application uses Kubernetes-native solutions, to avoid vendor lock-in.</span></span>
- <span data-ttu-id="fb654-177">该应用程序使用微服务体系结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-177">The application uses a microservices architecture.</span></span>
- <span data-ttu-id="fb654-178">Azure Stack Hub 不需要入站连接，但允许出站 Internet 连接。</span><span class="sxs-lookup"><span data-stu-id="fb654-178">Azure Stack Hub doesn't need inbound but allows outbound Internet connectivity.</span></span>

<span data-ttu-id="fb654-179">这些建议的做法也适用于实际工作负载和场景。</span><span class="sxs-lookup"><span data-stu-id="fb654-179">These recommended practices will apply to real-world workloads and scenarios as well.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="fb654-180">可伸缩性注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-180">Scalability considerations</span></span>

<span data-ttu-id="fb654-181">若要为用户提供对应用程序的一致、可靠且性能良好的访问，可伸缩性非常重要。</span><span class="sxs-lookup"><span data-stu-id="fb654-181">Scalability is important to provide users consistent, reliable, and well-performing access to the application.</span></span>

<span data-ttu-id="fb654-182">该示例场景涵盖了应用程序堆栈在多层上的可伸缩性。</span><span class="sxs-lookup"><span data-stu-id="fb654-182">The sample scenario covers scalability on multiple layers of the application stack.</span></span> <span data-ttu-id="fb654-183">下面是不同层的大致概述：</span><span class="sxs-lookup"><span data-stu-id="fb654-183">Here's a high-level overview of the different layers:</span></span>

| <span data-ttu-id="fb654-184">体系结构级别</span><span class="sxs-lookup"><span data-stu-id="fb654-184">Architecture level</span></span> | <span data-ttu-id="fb654-185">影响</span><span class="sxs-lookup"><span data-stu-id="fb654-185">Affects</span></span> | <span data-ttu-id="fb654-186">如何操作？</span><span class="sxs-lookup"><span data-stu-id="fb654-186">How?</span></span> |
| --- | --- | ---
| <span data-ttu-id="fb654-187">应用程序</span><span class="sxs-lookup"><span data-stu-id="fb654-187">Application</span></span> | <span data-ttu-id="fb654-188">应用程序</span><span class="sxs-lookup"><span data-stu-id="fb654-188">Application</span></span> | <span data-ttu-id="fb654-189">基于 Pod/副本/容器实例数量的横向缩放\*</span><span class="sxs-lookup"><span data-stu-id="fb654-189">Horizontal scaling based on the number of Pods/Replicas/Container Instances\*</span></span> |
| <span data-ttu-id="fb654-190">群集</span><span class="sxs-lookup"><span data-stu-id="fb654-190">Cluster</span></span> | <span data-ttu-id="fb654-191">Kubernetes 群集</span><span class="sxs-lookup"><span data-stu-id="fb654-191">Kubernetes cluster</span></span> | <span data-ttu-id="fb654-192">节点数（1 至 50）、VM-SKU 大小和节点池（Azure Stack Hub 上的 AKS 引擎目前仅支持单个节点池）；使用 AKS 引擎的缩放命令（手动）</span><span class="sxs-lookup"><span data-stu-id="fb654-192">Number of Nodes (between 1 and 50), VM-SKU-sizes, and Node Pools (AKS Engine on Azure Stack Hub currently supports only a single node pool); using AKS Engine's scale command (manual)</span></span> |
| <span data-ttu-id="fb654-193">基础结构</span><span class="sxs-lookup"><span data-stu-id="fb654-193">Infrastructure</span></span> | <span data-ttu-id="fb654-194">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="fb654-194">Azure Stack Hub</span></span> | <span data-ttu-id="fb654-195">Azure Stack Hub 部署中的节点数、容量和缩放单元</span><span class="sxs-lookup"><span data-stu-id="fb654-195">Number of nodes, capacity, and scale units within an Azure Stack Hub deployment</span></span> |

<span data-ttu-id="fb654-196">\* 使用 Kubernetes 的水平 Pod 自动缩放程序 (HPA)；通过调整容器实例的大小（CPU/内存）来实现基于指标的自动缩放或纵向缩放。</span><span class="sxs-lookup"><span data-stu-id="fb654-196">\* Using Kubernetes' Horizontal Pod Autoscaler (HPA); automated metric-based scaling or vertical scaling by sizing the container instances (cpu/memory).</span></span>

<span data-ttu-id="fb654-197">Azure Stack Hub（基础结构级别）</span><span class="sxs-lookup"><span data-stu-id="fb654-197">**Azure Stack Hub (infrastructure level)**</span></span>

<span data-ttu-id="fb654-198">Azure Stack Hub 基础结构是此实现的基础，因为 Azure Stack Hub 在数据中心的物理硬件上运行。</span><span class="sxs-lookup"><span data-stu-id="fb654-198">The Azure Stack Hub infrastructure is the foundation of this implementation, because Azure Stack Hub runs on physical hardware in a datacenter.</span></span> <span data-ttu-id="fb654-199">选择 Hub 硬件时，需要选择 CPU、内存密度、存储配置和服务器数量。</span><span class="sxs-lookup"><span data-stu-id="fb654-199">When selecting your Hub hardware, you need to make choices for CPU, memory density, storage configuration, and number of servers.</span></span> <span data-ttu-id="fb654-200">若要详细了解 Azure Stack Hub 的可伸缩性，请查看以下资源：</span><span class="sxs-lookup"><span data-stu-id="fb654-200">To learn more about Azure Stack Hub's scalability, check out the following resources:</span></span>

- [<span data-ttu-id="fb654-201">Azure Stack Hub 的容量计划概述</span><span class="sxs-lookup"><span data-stu-id="fb654-201">Capacity planning for Azure Stack Hub overview</span></span>](/azure-stack/operator/azure-stack-capacity-planning-overview)
- [<span data-ttu-id="fb654-202">在 Azure Stack Hub 中添加更多的缩放单元节点</span><span class="sxs-lookup"><span data-stu-id="fb654-202">Add additional scale unit nodes in Azure Stack Hub</span></span>](/azure-stack/operator/azure-stack-add-scale-node)

<span data-ttu-id="fb654-203">Kubernetes 群集（群集级别）</span><span class="sxs-lookup"><span data-stu-id="fb654-203">**Kubernetes cluster (cluster level)**</span></span>

<span data-ttu-id="fb654-204">Kubernetes 群集本身由 Azure (Stack) IaaS 组件（包括计算、存储和网络资源）组成，并在这些组件的基础上生成。</span><span class="sxs-lookup"><span data-stu-id="fb654-204">The Kubernetes cluster itself consists of, and is built on top of Azure (Stack) IaaS components including compute, storage, and network resources.</span></span> <span data-ttu-id="fb654-205">Kubernetes 解决方案涉及主节点和工作器节点，它们作为 VM 部署在 Azure（和 Azure Stack Hub）中。</span><span class="sxs-lookup"><span data-stu-id="fb654-205">Kubernetes solutions involve master and worker nodes, which are deployed as VMs in Azure (and Azure Stack Hub).</span></span>

- <span data-ttu-id="fb654-206">[控制平面节点](/azure/aks/concepts-clusters-workloads#control-plane)（主节点）提供核心 Kubernetes 服务和应用程序工作负载的业务流程。</span><span class="sxs-lookup"><span data-stu-id="fb654-206">[Control plane nodes](/azure/aks/concepts-clusters-workloads#control-plane) (master) provide the core Kubernetes services and orchestration of application workloads.</span></span>
- <span data-ttu-id="fb654-207">[工作器节点](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools)（工作器节点）运行应用程序工作负载。</span><span class="sxs-lookup"><span data-stu-id="fb654-207">[Worker nodes](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) (worker) run your application workloads.</span></span>

<span data-ttu-id="fb654-208">为初始部署选择 VM 大小时，需要注意以下事项：</span><span class="sxs-lookup"><span data-stu-id="fb654-208">When selecting VM sizes for the initial deployment, there are several considerations:</span></span>  

- <span data-ttu-id="fb654-209">**成本** - 在规划工作器节点时，请记住每个 VM 将产生的总成本。</span><span class="sxs-lookup"><span data-stu-id="fb654-209">**Cost** - When planning your worker nodes, keep in mind the overall cost per VM you'll incur.</span></span> <span data-ttu-id="fb654-210">例如，如果应用程序工作负载需要有限的资源，则应计划部署规模较小的 VM。</span><span class="sxs-lookup"><span data-stu-id="fb654-210">For example, if your application workloads require limited resources, you should plan to deploy smaller sized VMs.</span></span> <span data-ttu-id="fb654-211">与 Azure 一样，Azure Stack Hub 通常按使用量计费，因此，针对 Kubernetes 角色适当调整 VM 大小对于优化使用成本至关重要。</span><span class="sxs-lookup"><span data-stu-id="fb654-211">Azure Stack Hub, like Azure, is normally billed on a consumption basis, so appropriately sizing the VMs for Kubernetes roles is crucial to optimizing consumption costs.</span></span> 

- <span data-ttu-id="fb654-212">**可伸缩性** - 群集的可伸缩性通过以下方式实现：增加和减少主节点和工作器节点的数量，或添加其他节点池（目前 Azure Stack Hub 上不可用）。</span><span class="sxs-lookup"><span data-stu-id="fb654-212">**Scalability** - Scalability of the cluster is achieved by scaling in and out the number of master and worker nodes, or by adding additional node pools (not available on Azure Stack Hub today).</span></span> <span data-ttu-id="fb654-213">群集缩放可以根据使用容器见解 (Azure Monitor + Log Analytics) 收集的性能数据来实现。</span><span class="sxs-lookup"><span data-stu-id="fb654-213">Scaling the cluster can be done based on performance data, collected using Container Insights (Azure Monitor + Log Analytics).</span></span> 

    <span data-ttu-id="fb654-214">如果应用程序需要更多（或更少）资源，则可以横向扩展（或横向缩减）当前节点（介于 1 到 50 个节点之间）。</span><span class="sxs-lookup"><span data-stu-id="fb654-214">If your application needs more (or fewer) resources, you can scale out (or in) your current nodes horizontally (between 1 and 50 nodes).</span></span> <span data-ttu-id="fb654-215">如果需要 50 个以上的节点，则可以在单独的订阅中创建其他群集。</span><span class="sxs-lookup"><span data-stu-id="fb654-215">If you need more than 50 nodes, you can create an additional cluster in a separate subscription.</span></span> <span data-ttu-id="fb654-216">若不重新部署群集，就不能将实际 VM 垂直（纵向）扩展到其他 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="fb654-216">You can't scale up the actual VMs vertically to another VM size without redeploying the cluster.</span></span>

    <span data-ttu-id="fb654-217">缩放是使用最初用于部署 Kubernetes 群集的 AKS 引擎帮助程序 VM 手动完成的。</span><span class="sxs-lookup"><span data-stu-id="fb654-217">Scaling is done manually using the AKS Engine helper VM that was used to deploy the Kubernetes cluster initially.</span></span> <span data-ttu-id="fb654-218">有关详细信息，请参阅[缩放 Kubernetes 群集](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span><span class="sxs-lookup"><span data-stu-id="fb654-218">For more information, see [Scaling Kubernetes clusters](https://github.com/Azure/aks-engine/blob/master/docs/topics/scale.md)</span></span>

- <span data-ttu-id="fb654-219">**配额** - 请考虑在 Azure Stack Hub 上计划 AKS 部署时所配置的[配额](/azure-stack/operator/azure-stack-quota-types)。</span><span class="sxs-lookup"><span data-stu-id="fb654-219">**Quotas** - Consider the [quotas](/azure-stack/operator/azure-stack-quota-types) you've configured when planning out an AKS deployment on your Azure Stack Hub.</span></span> <span data-ttu-id="fb654-220">请确保每个[订阅](/azure-stack/operator/service-plan-offer-subscription-overview)都具有适当计划并配置了配额。</span><span class="sxs-lookup"><span data-stu-id="fb654-220">Make sure each [subscription](/azure-stack/operator/service-plan-offer-subscription-overview) has the proper plans and the quotas configured.</span></span> <span data-ttu-id="fb654-221">订阅将需要容纳群集横向扩展所需的计算、存储和其他服务的数量。</span><span class="sxs-lookup"><span data-stu-id="fb654-221">The subscription will need to accommodate the amount of compute, storage, and other services needed for your clusters as they scale out.</span></span>

- <span data-ttu-id="fb654-222">**应用程序工作负载** - 请参阅 Azure Kubernetes 服务的 Kubernetes 核心概念中的[群集和工作负载概念](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools)。</span><span class="sxs-lookup"><span data-stu-id="fb654-222">**Application workloads** - Refer to the [Clusters and workloads concepts](/azure/aks/concepts-clusters-workloads#nodes-and-node-pools) in the Kubernetes core concepts for Azure Kubernetes Service document.</span></span> <span data-ttu-id="fb654-223">本文将帮助你根据应用程序的计算和内存需求来确定合适的 VM 大小。</span><span class="sxs-lookup"><span data-stu-id="fb654-223">This article will help you scope the proper VM size based on the compute and memory needs of your application.</span></span>  

<span data-ttu-id="fb654-224">**应用程序（应用程序级别）**</span><span class="sxs-lookup"><span data-stu-id="fb654-224">**Application (application level)**</span></span>

<span data-ttu-id="fb654-225">在应用程序层上，我们使用 Kubernetes [水平 Pod 自动缩放程序 (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/)。</span><span class="sxs-lookup"><span data-stu-id="fb654-225">On the application layer, we use Kubernetes [Horizontal Pod Autoscaler (HPA)](https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/).</span></span> <span data-ttu-id="fb654-226">HPA 可以根据不同指标（例如 CPU 利用率）来增加或减少部署中的副本（Pod/容器实例）数量。</span><span class="sxs-lookup"><span data-stu-id="fb654-226">HPA can increase or decrease the number of Replicas (Pod/Container Instances) in our deployment based on different metrics (like CPU utilization).</span></span>

<span data-ttu-id="fb654-227">另一种方法是垂直缩放容器实例。</span><span class="sxs-lookup"><span data-stu-id="fb654-227">Another option is to scale container instances vertically.</span></span> <span data-ttu-id="fb654-228">可以通过更改特定部署所请求的和可用的 CPU 和内存数量来实现此举。</span><span class="sxs-lookup"><span data-stu-id="fb654-228">This can be accomplished by changing the amount of CPU and Memory requested and available for a specific deployment.</span></span> <span data-ttu-id="fb654-229">请参阅 kubernetes.io 上的[管理容器资源](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)以了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-229">See [Managing Resources for Containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/) on kubernetes.io to learn more.</span></span>

## <a name="networking-and-connectivity-considerations"></a><span data-ttu-id="fb654-230">网络和连接性注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-230">Networking and connectivity considerations</span></span>

<span data-ttu-id="fb654-231">网络和连接性也会影响前面提到的 Azure Stack Hub 上的 Kubernetes 的三种层。</span><span class="sxs-lookup"><span data-stu-id="fb654-231">Networking and connectivity also affect the three layers mentioned previously for Kubernetes on Azure Stack Hub.</span></span> <span data-ttu-id="fb654-232">下表显示了这些层以及其中包含的服务：</span><span class="sxs-lookup"><span data-stu-id="fb654-232">The following table shows the layers and which services they contain:</span></span>

| <span data-ttu-id="fb654-233">层</span><span class="sxs-lookup"><span data-stu-id="fb654-233">Layer</span></span> | <span data-ttu-id="fb654-234">影响</span><span class="sxs-lookup"><span data-stu-id="fb654-234">Affects</span></span> | <span data-ttu-id="fb654-235">什么？</span><span class="sxs-lookup"><span data-stu-id="fb654-235">What?</span></span> |
| --- | --- | ---
| <span data-ttu-id="fb654-236">应用程序</span><span class="sxs-lookup"><span data-stu-id="fb654-236">Application</span></span> | <span data-ttu-id="fb654-237">应用程序</span><span class="sxs-lookup"><span data-stu-id="fb654-237">Application</span></span> | <span data-ttu-id="fb654-238">如何访问应用程序？</span><span class="sxs-lookup"><span data-stu-id="fb654-238">How is the application accessible?</span></span> <span data-ttu-id="fb654-239">是否会向 Internet 公开？</span><span class="sxs-lookup"><span data-stu-id="fb654-239">Will it be exposed to the Internet?</span></span> |
| <span data-ttu-id="fb654-240">群集</span><span class="sxs-lookup"><span data-stu-id="fb654-240">Cluster</span></span> | <span data-ttu-id="fb654-241">Kubernetes 群集</span><span class="sxs-lookup"><span data-stu-id="fb654-241">Kubernetes cluster</span></span> | <span data-ttu-id="fb654-242">Kubernetes API、AKS 引擎 VM、拉取容器映像（流出量）、发送监视数据和遥测（流出量）</span><span class="sxs-lookup"><span data-stu-id="fb654-242">Kubernetes API, AKS Engine VM, Pulling container images (egress), Sending monitoring data and telemetry (egress)</span></span> |
| <span data-ttu-id="fb654-243">基础结构</span><span class="sxs-lookup"><span data-stu-id="fb654-243">Infrastructure</span></span> | <span data-ttu-id="fb654-244">Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="fb654-244">Azure Stack Hub</span></span> | <span data-ttu-id="fb654-245">Azure Stack Hub 管理终结点（如门户网站和 Azure 资源管理器终结点）的可访问性。</span><span class="sxs-lookup"><span data-stu-id="fb654-245">Accessibility of the Azure Stack Hub management endpoints like the portal and Azure Resource Manager endpoints.</span></span> |

<span data-ttu-id="fb654-246">**应用程序**</span><span class="sxs-lookup"><span data-stu-id="fb654-246">**Application**</span></span>

<span data-ttu-id="fb654-247">对于应用程序层，最重要的注意事项是应用程序是否公开并可从 Internet 访问。</span><span class="sxs-lookup"><span data-stu-id="fb654-247">For the application layer, the most important consideration is whether the application is exposed and accessible from the Internet.</span></span> <span data-ttu-id="fb654-248">从 Kubernetes 的角度来看，Internet 可访问性意味着使用 Kubernetes 服务或入口控制器公开部署或 Pod。</span><span class="sxs-lookup"><span data-stu-id="fb654-248">From a Kubernetes perspective, Internet accessibility means exposing a deployment or pod using a Kubernetes Service or an Ingress Controller.</span></span>

> [!NOTE]
> <span data-ttu-id="fb654-249">建议使用入口控制器公开 Kubernetes 服务，因为 Azure Stack Hub 上的前端公共 IP 数限制为 5。</span><span class="sxs-lookup"><span data-stu-id="fb654-249">We recommend the use of Ingress controllers to expose Kubernetes Services as the number of Frontend public IPs on Azure Stack Hub is limited to 5.</span></span> <span data-ttu-id="fb654-250">这种设计还将 Kubernetes 服务（类型为 LoadBalancer）限制为 5，这对于许多部署来说都过小。</span><span class="sxs-lookup"><span data-stu-id="fb654-250">This design also limits the number of Kubernetes Services (with the type LoadBalancer) to 5, which will be too small for many deployments.</span></span> <span data-ttu-id="fb654-251">请转到 [AKS 引擎文档](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips)，了解详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-251">Go to the [AKS Engine documentation](https://github.com/Azure/aks-engine/blob/master/docs/topics/azure-stack.md#limited-number-of-frontend-public-ips) to learn more.</span></span>

<span data-ttu-id="fb654-252">通过负载均衡器或入口控制器使用公共 IP 公开应用程序并不意味着现在可以通过 Internet 访问该应用程序。</span><span class="sxs-lookup"><span data-stu-id="fb654-252">Exposing an application using a public IP via a Load Balancer or an Ingress Controller doesn't nessecarily mean that the application is now accessible via the Internet.</span></span> <span data-ttu-id="fb654-253">Azure Stack Hub 可能有一个仅在本地 Intranet 上可见的公共 IP 地址，这是因为并非所有公共 IP 都真正面向 Internet。</span><span class="sxs-lookup"><span data-stu-id="fb654-253">It's possible for Azure Stack Hub to have a public IP address that is only visible on the local intranet - not all public IPs are truly Internet-facing.</span></span>

<span data-ttu-id="fb654-254">上一个块考虑应用程序的入口流量。</span><span class="sxs-lookup"><span data-stu-id="fb654-254">The previous block considers ingress traffic to the application.</span></span> <span data-ttu-id="fb654-255">成功的 Kubernetes 部署必须考虑的另一个主题是出站/出口流量。</span><span class="sxs-lookup"><span data-stu-id="fb654-255">Another topic that must be considered for a successful Kubernetes deployment is outbound/egress traffic.</span></span> <span data-ttu-id="fb654-256">以下是需要出口流量的几个用例：</span><span class="sxs-lookup"><span data-stu-id="fb654-256">Here are a few use cases that require egress traffic:</span></span>

- <span data-ttu-id="fb654-257">拉取存储在 DockerHub 或 Azure 容器注册表中的容器映像</span><span class="sxs-lookup"><span data-stu-id="fb654-257">Pulling Container Images stored on DockerHub or Azure Container Registry</span></span>
- <span data-ttu-id="fb654-258">检索 Helm 图表</span><span class="sxs-lookup"><span data-stu-id="fb654-258">Retrieving Helm Charts</span></span>
- <span data-ttu-id="fb654-259">发出 Application Insights 数据（或其他监视数据）</span><span class="sxs-lookup"><span data-stu-id="fb654-259">Emitting Application Insights data (or other monitoring data)</span></span>

<span data-ttu-id="fb654-260">某些企业环境可能需要使用透明或非透明代理服务器 。</span><span class="sxs-lookup"><span data-stu-id="fb654-260">Some enterprise environments might require the use of _transparent_ or _non-transparent_ proxy servers.</span></span> <span data-ttu-id="fb654-261">这些服务器需要在群集的各个组件上进行特定配置。</span><span class="sxs-lookup"><span data-stu-id="fb654-261">These servers require specific configuration on various components of our cluster.</span></span> <span data-ttu-id="fb654-262">AKS 引擎文档包含有关如何适应网络代理的各种详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-262">The AKS Engine documentation contains various details on how to accommodate network proxies.</span></span> <span data-ttu-id="fb654-263">有关更多详细信息，请参阅 [AKS 引擎和代理服务器](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span><span class="sxs-lookup"><span data-stu-id="fb654-263">For more details, see [AKS Engine and proxy servers](https://github.com/Azure/aks-engine/blob/master/docs/topics/proxy-servers.md)</span></span>

<span data-ttu-id="fb654-264">最后，跨群集流量必须在 Azure Stack Hub 实例之间流动。</span><span class="sxs-lookup"><span data-stu-id="fb654-264">Lastly, cross-cluster traffic must flow between Azure Stack Hub instances.</span></span> <span data-ttu-id="fb654-265">该示例部署由在各个 Azure Stack Hub 实例上运行的各个 Kubernetes 群集组成。</span><span class="sxs-lookup"><span data-stu-id="fb654-265">The sample deployment consists of individual Kubernetes clusters running on individual Azure Stack Hub instances.</span></span> <span data-ttu-id="fb654-266">它们之间的流量（例如两个数据库之间的复制流量）是“外部流量”。</span><span class="sxs-lookup"><span data-stu-id="fb654-266">Traffic between them, such as the replication traffic between two databases, is "external traffic".</span></span> <span data-ttu-id="fb654-267">必须通过站点到站点 VPN 或 Azure Stack Hub 公共 IP 地址路由外部流量，以连接两个 Azure Stack Hub 实例上的 Kubernetes：</span><span class="sxs-lookup"><span data-stu-id="fb654-267">External traffic must be routed through either a Site-to-Site VPN or Azure Stack Hub Public IP addresses to connect Kubernetes on two Azure Stack Hub instances:</span></span>

![群集间和群集内流量](media/pattern-highly-available-kubernetes/aks-inter-and-intra-cluster-traffic.png)

<span data-ttu-id="fb654-269">**Cluster**</span><span class="sxs-lookup"><span data-stu-id="fb654-269">**Cluster**</span></span>  

<span data-ttu-id="fb654-270">Kubernetes 群集不一定需要可通过 Internet 访问。</span><span class="sxs-lookup"><span data-stu-id="fb654-270">The Kubernetes cluster doesn't necessarily need to be accessible via the Internet.</span></span> <span data-ttu-id="fb654-271">相关部分是用于操作群集的 Kubernetes API，例如使用 `kubectl`。</span><span class="sxs-lookup"><span data-stu-id="fb654-271">The relevant part is the Kubernetes API used to operate a cluster, for example, using `kubectl`.</span></span> <span data-ttu-id="fb654-272">Kubernetes API 终结点必须可供所有操作群集或部署以群集为基础的应用程序和服务的用户访问。</span><span class="sxs-lookup"><span data-stu-id="fb654-272">The Kubernetes API endpoint must be accessible to everyone who operates the cluster or deploys applications and services on top of it.</span></span> <span data-ttu-id="fb654-273">下面的[部署 (CI/CD) 注意事项](#deployment-cicd-considerations)部分从 DevOps 角度更详细地介绍了这一主题。</span><span class="sxs-lookup"><span data-stu-id="fb654-273">This topic is covered in more detail from a DevOps-perspective in the [Deployment (CI/CD) considerations](#deployment-cicd-considerations) section below.</span></span>

<span data-ttu-id="fb654-274">在群集级别，还需要考虑有关出口流量的一些注意事项：</span><span class="sxs-lookup"><span data-stu-id="fb654-274">On the cluster level, there are also a few considerations around egress-traffic:</span></span>

- <span data-ttu-id="fb654-275">节点更新（对于 Ubuntu）</span><span class="sxs-lookup"><span data-stu-id="fb654-275">Node updates (for Ubuntu)</span></span>
- <span data-ttu-id="fb654-276">监视数据（发送到 Azure LogAnalytics）</span><span class="sxs-lookup"><span data-stu-id="fb654-276">Monitoring data (sent to Azure LogAnalytics)</span></span>
- <span data-ttu-id="fb654-277">需要出站流量的其他代理（特定于每个部署人员的环境）</span><span class="sxs-lookup"><span data-stu-id="fb654-277">Other agents requiring outbound traffic (specific to each deployer's environment)</span></span>

<span data-ttu-id="fb654-278">使用 AKS 引擎部署 Kubernetes 群集之前，请规划最终网络设计。</span><span class="sxs-lookup"><span data-stu-id="fb654-278">Before you deploy your Kubernetes cluster using AKS Engine, plan for the final networking design.</span></span> <span data-ttu-id="fb654-279">将群集部署到现有网络可能更高效，而不是创建专用虚拟网络。</span><span class="sxs-lookup"><span data-stu-id="fb654-279">Instead of creating a dedicated Virtual Network, it may be more efficient to deploy a cluster into an existing network.</span></span> <span data-ttu-id="fb654-280">例如，你可以利用已在 Azure Stack Hub 环境中配置的现有站点到站点 VPN 连接。</span><span class="sxs-lookup"><span data-stu-id="fb654-280">For example, you might leverage an existing Site-to-Site VPN connection already configured in your Azure Stack Hub environment.</span></span>

<span data-ttu-id="fb654-281">**基础结构**</span><span class="sxs-lookup"><span data-stu-id="fb654-281">**Infrastructure**</span></span>  

<span data-ttu-id="fb654-282">基础结构是指访问 Azure Stack Hub 管理终结点。</span><span class="sxs-lookup"><span data-stu-id="fb654-282">Infrastructure refers to accessing the Azure Stack Hub management endpoints.</span></span> <span data-ttu-id="fb654-283">终结点包括租户和管理门户，以及 Azure 资源管理器管理员和租户终结点。</span><span class="sxs-lookup"><span data-stu-id="fb654-283">Endpoints include the tenant and admin portals, and the Azure Resource Manager admin and tenant endpoints.</span></span> <span data-ttu-id="fb654-284">需要这些终结点才能操作 Azure Stack Hub 及其核心服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-284">These endpoints are required to operate Azure Stack Hub and its core services.</span></span>

## <a name="data-and-storage-considerations"></a><span data-ttu-id="fb654-285">数据和存储注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-285">Data and storage considerations</span></span>

<span data-ttu-id="fb654-286">我们的应用程序的两个实例将跨两个 Azure Stack Hub 实例部署在两个单独的 Kubernetes 群集上。</span><span class="sxs-lookup"><span data-stu-id="fb654-286">Two instances of our application will be deployed, on two individual Kubernetes clusters, across two Azure Stack Hub instances.</span></span> <span data-ttu-id="fb654-287">这种设计将需要我们考虑如何在实例之间复制和同步数据。</span><span class="sxs-lookup"><span data-stu-id="fb654-287">This design will require us to consider how to replicate and synchronize data between them.</span></span>

<span data-ttu-id="fb654-288">Azure 向我们提供了内置功能，可以跨云中的多个区域和地区复制存储。</span><span class="sxs-lookup"><span data-stu-id="fb654-288">With Azure, we have the built-in capability to replicate storage across multiple regions and zones within the cloud.</span></span> <span data-ttu-id="fb654-289">当前，对于 Azure Stack Hub，没有原生方式可用于在两个不同的 Azure Stack Hub 实例之间复制存储，这两个实例会形成两个独立的云，没有办法将其作为一个集合来管理。</span><span class="sxs-lookup"><span data-stu-id="fb654-289">Currently with Azure Stack Hub there are no native ways to replicate storage across two different Azure Stack Hub instances - they form two independent clouds with no overarching way to manage them as a set.</span></span> <span data-ttu-id="fb654-290">规划跨 Azure Stack Hub 运行的应用程序的复原能力会迫使你在应用程序设计和部署中考虑这种独立性。</span><span class="sxs-lookup"><span data-stu-id="fb654-290">Planning for resiliency of applications running across Azure Stack Hub forces you to consider this independence in your application design and deployments.</span></span>

<span data-ttu-id="fb654-291">在大多数情况下，对于在 AKS 上部署的可复原和高可用性应用程序，存储复制不是必需的。</span><span class="sxs-lookup"><span data-stu-id="fb654-291">In most cases, storage replication won't be necessary for a resilient and highly available application deployed on AKS.</span></span> <span data-ttu-id="fb654-292">但在应用程序设计中，应考虑每个 Azure Stack Hub 实例的独立存储。</span><span class="sxs-lookup"><span data-stu-id="fb654-292">But you should consider independent storage per Azure Stack Hub instance in your application design.</span></span> <span data-ttu-id="fb654-293">如果这种设计是在 Azure Stack Hub 上部署解决方案的一种顾虑或障碍，或许 Microsoft 合作伙伴的解决方案可提供存储附件。</span><span class="sxs-lookup"><span data-stu-id="fb654-293">If this design is a concern or road block to deploying the solution on Azure Stack Hub, there are possible solutions from Microsoft Partners that provide storage attachments.</span></span> <span data-ttu-id="fb654-294">存储附件提供了跨多个 Azure Stack Hub 和 Azure 的存储复制解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-294">Storage attachments provide a storage replication solution across multiple Azure Stack Hubs and Azure.</span></span> <span data-ttu-id="fb654-295">有关详细信息，请参阅[合作伙伴解决方案](#partner-solutions)。</span><span class="sxs-lookup"><span data-stu-id="fb654-295">For more information, see the [Partner solutions](#partner-solutions).</span></span>

<span data-ttu-id="fb654-296">在我们的体系结构中，考虑了以下各层：</span><span class="sxs-lookup"><span data-stu-id="fb654-296">In our architecture, these layers were considered:</span></span>

<span data-ttu-id="fb654-297">**配置**</span><span class="sxs-lookup"><span data-stu-id="fb654-297">**Configuration**</span></span>

<span data-ttu-id="fb654-298">配置包括 Azure Stack Hub、AKS 引擎以及 Kubernetes 群集本身的配置。</span><span class="sxs-lookup"><span data-stu-id="fb654-298">Configuration includes the configuration of Azure Stack Hub, AKS Engine, and the Kubernetes cluster itself.</span></span> <span data-ttu-id="fb654-299">配置应尽可能自动化，并以基础结构即代码的形式存储在基于 Git 的版本控制系统（如 Azure DevOps 或 GitHub）中。</span><span class="sxs-lookup"><span data-stu-id="fb654-299">The configuration should be automated as much as possible, and stored as Infrastructure-as-Code in a Git-based version control system like Azure DevOps or GitHub.</span></span> <span data-ttu-id="fb654-300">这些设置不能轻松在多种部署之间同步。</span><span class="sxs-lookup"><span data-stu-id="fb654-300">These settings cannot easily be synchronized across multiple deployments.</span></span> <span data-ttu-id="fb654-301">因此，我们建议在外部存储和应用配置，并使用 DevOps 管道。</span><span class="sxs-lookup"><span data-stu-id="fb654-301">Therefore we recommend storing and applying configuration from the outside, and using DevOps pipeline.</span></span>

<span data-ttu-id="fb654-302">**应用程序**</span><span class="sxs-lookup"><span data-stu-id="fb654-302">**Application**</span></span>

<span data-ttu-id="fb654-303">应用程序应存储在基于 Git 的存储库中。</span><span class="sxs-lookup"><span data-stu-id="fb654-303">The application should be stored in a Git-based repository.</span></span> <span data-ttu-id="fb654-304">每当进行新部署、对应用程序进行更改或进行灾难恢复时，都可以使用 Azure Pipelines 轻松进行部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-304">Whenever there's a new deployment, changes to the application, or disaster recovery, it can be easily deployed using Azure Pipelines.</span></span>

<span data-ttu-id="fb654-305">数据</span><span class="sxs-lookup"><span data-stu-id="fb654-305">**Data**</span></span>

<span data-ttu-id="fb654-306">在大多数应用程序设计中，数据是最重要的考虑因素。</span><span class="sxs-lookup"><span data-stu-id="fb654-306">Data is the most important consideration in most application designs.</span></span> <span data-ttu-id="fb654-307">应用程序数据必须在应用程序的不同实例之间保持同步。</span><span class="sxs-lookup"><span data-stu-id="fb654-307">Application data must stay in sync between the different instances of the application.</span></span> <span data-ttu-id="fb654-308">如果发生中断，数据还需要备份和灾难恢复策略。</span><span class="sxs-lookup"><span data-stu-id="fb654-308">Data also needs a backup and disaster recovery strategy if there's an outage.</span></span>

<span data-ttu-id="fb654-309">这种设计的实现很大程度上取决于技术选择。</span><span class="sxs-lookup"><span data-stu-id="fb654-309">Achieving this design depends heavily on technology choices.</span></span> <span data-ttu-id="fb654-310">下面是一些在 Azure Stack Hub 上以高可用性方式实现数据库的解决方案示例：</span><span class="sxs-lookup"><span data-stu-id="fb654-310">Here are some solution examples for implementing a database in a highly available fashion on Azure Stack Hub:</span></span>

- [<span data-ttu-id="fb654-311">将 SQL Server 2016 可用性组部署到 Azure 和 Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="fb654-311">Deploy a SQL Server 2016 availability group to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-sql-ha)
- [<span data-ttu-id="fb654-312">将高度可用的 MongoDB 解决方案部署到 Azure 和 Azure Stack Hub</span><span class="sxs-lookup"><span data-stu-id="fb654-312">Deploy a highly available MongoDB solution to Azure and Azure Stack Hub</span></span>](/azure-stack/hybrid/solution-deployment-guide-mongodb-ha)

<span data-ttu-id="fb654-313">对于高可用性和可复原解决方案，跨多个位置处理数据时的注意事项甚至更为复杂。</span><span class="sxs-lookup"><span data-stu-id="fb654-313">Considerations when working with data across multiple locations is an even more complex consideration for a highly available and resilient solution.</span></span> <span data-ttu-id="fb654-314">请注意以下几点：</span><span class="sxs-lookup"><span data-stu-id="fb654-314">Consider:</span></span>

- <span data-ttu-id="fb654-315">Azure Stack Hub 之间的延迟和网络连接。</span><span class="sxs-lookup"><span data-stu-id="fb654-315">Latency and network connectivity between Azure Stack Hubs.</span></span>
- <span data-ttu-id="fb654-316">服务和权限的标识可用性。</span><span class="sxs-lookup"><span data-stu-id="fb654-316">Availability of identities for services and permissions.</span></span> <span data-ttu-id="fb654-317">每个 Azure Stack Hub 实例都与一个外部目录集成。</span><span class="sxs-lookup"><span data-stu-id="fb654-317">Each Azure Stack Hub instance integrates with an external directory.</span></span> <span data-ttu-id="fb654-318">在部署期间，可选择使用 Azure Active Directory (Azure AD) 或Active Directory 联合身份验证服务 (ADFS)。</span><span class="sxs-lookup"><span data-stu-id="fb654-318">During deployment, you choose to use either Azure Active Directory (Azure AD) or Active Directory Federation Services (ADFS).</span></span> <span data-ttu-id="fb654-319">这样，就有可能仅使用一个标识，该标识可与多个独立的 Azure Stack Hub 实例进行交互。</span><span class="sxs-lookup"><span data-stu-id="fb654-319">As such, there's potential to use a single identity that can interact with multiple independent Azure Stack Hub instances.</span></span>

## <a name="business-continuity-and-disaster-recovery"></a><span data-ttu-id="fb654-320">业务连续性和灾难恢复</span><span class="sxs-lookup"><span data-stu-id="fb654-320">Business continuity and disaster recovery</span></span>

<span data-ttu-id="fb654-321">业务连续性和灾难恢复 (BCDR) 是 Azure Stack Hub 和 Azure 中的一个重要主题。</span><span class="sxs-lookup"><span data-stu-id="fb654-321">Business continuity and disaster recovery (BCDR) is an important topic in both Azure Stack Hub and Azure.</span></span> <span data-ttu-id="fb654-322">主要区别在于，在 Azure Stack Hub，操作员必须管理整个 BCDR 过程。</span><span class="sxs-lookup"><span data-stu-id="fb654-322">The main difference is that in Azure Stack Hub, the operator must manage the whole BCDR process.</span></span> <span data-ttu-id="fb654-323">在 Azure 中，BCDR 的部件由 Microsoft 自动管理。</span><span class="sxs-lookup"><span data-stu-id="fb654-323">In Azure, parts of BCDR are automatically managed by Microsoft.</span></span>

<span data-ttu-id="fb654-324">BCDR 会影响前一部分[数据和存储注意事项](#data-and-storage-considerations)中提到的相同区域：</span><span class="sxs-lookup"><span data-stu-id="fb654-324">BCDR affects the same areas mentioned in the previous section [Data and storage considerations](#data-and-storage-considerations):</span></span>

- <span data-ttu-id="fb654-325">基础结构/配置</span><span class="sxs-lookup"><span data-stu-id="fb654-325">Infrastructure / Configuration</span></span>
- <span data-ttu-id="fb654-326">应用程序可用性</span><span class="sxs-lookup"><span data-stu-id="fb654-326">Application Availability</span></span>
- <span data-ttu-id="fb654-327">应用程序数据</span><span class="sxs-lookup"><span data-stu-id="fb654-327">Application Data</span></span>

<span data-ttu-id="fb654-328">如前一部分中所述，这些区域由 Azure Stack Hub 操作员负责，可能会因组织而异。</span><span class="sxs-lookup"><span data-stu-id="fb654-328">And as mentioned in the previous section, these areas are the responsibility of the Azure Stack Hub operator and can vary between organizations.</span></span> <span data-ttu-id="fb654-329">根据可用的工具和进程规划 BCDR。</span><span class="sxs-lookup"><span data-stu-id="fb654-329">Plan BCDR according to your available tools and processes.</span></span>

<span data-ttu-id="fb654-330">**基础结构和配置**</span><span class="sxs-lookup"><span data-stu-id="fb654-330">**Infrastructure and configuration**</span></span>

<span data-ttu-id="fb654-331">本部分介绍物理和逻辑基础结构以及 Azure Stack Hub 的配置。</span><span class="sxs-lookup"><span data-stu-id="fb654-331">This section covers the physical and logical infrastructure and the configuration of Azure Stack Hub.</span></span> <span data-ttu-id="fb654-332">其中包括管理员和租户空间中的操作。</span><span class="sxs-lookup"><span data-stu-id="fb654-332">It covers actions in the admin and the tenant spaces.</span></span>

<span data-ttu-id="fb654-333">Azure Stack Hub 操作员（或管理员）负责维护 Azure Stack Hub 实例。</span><span class="sxs-lookup"><span data-stu-id="fb654-333">The Azure Stack Hub operator (or administrator) is responsible for maintenance of the Azure Stack Hub instances.</span></span> <span data-ttu-id="fb654-334">包括网络、存储、标识等组件，以及不在本文讨论范围内的其他主题。</span><span class="sxs-lookup"><span data-stu-id="fb654-334">Including components such as the network, storage, identity, and other topics that are outside the scope of this article.</span></span> <span data-ttu-id="fb654-335">若要详细了解 Azure Stack Hub 操作的具体信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="fb654-335">To learn more about the specifics of Azure Stack Hub operations, see the following resources:</span></span>

- [<span data-ttu-id="fb654-336">使用基础结构备份服务恢复 Azure Stack Hub 中的数据</span><span class="sxs-lookup"><span data-stu-id="fb654-336">Recover data in Azure Stack Hub with the Infrastructure Backup Service</span></span>](/azure-stack/operator/azure-stack-backup-infrastructure-backup)
- [<span data-ttu-id="fb654-337">从管理员门户为 Azure Stack Hub 启用备份</span><span class="sxs-lookup"><span data-stu-id="fb654-337">Enable backup for Azure Stack Hub from the administrator portal</span></span>](/azure-stack/operator/azure-stack-backup-enable-backup-console)
- [<span data-ttu-id="fb654-338">在发生灾难性数据丢失后进行恢复</span><span class="sxs-lookup"><span data-stu-id="fb654-338">Recover from catastrophic data loss</span></span>](/azure-stack/operator/azure-stack-backup-recover-data)
- [<span data-ttu-id="fb654-339">基础结构备份服务最佳做法</span><span class="sxs-lookup"><span data-stu-id="fb654-339">Infrastructure Backup Service best practices</span></span>](/azure-stack/operator/azure-stack-backup-best-practices)

<span data-ttu-id="fb654-340">Azure Stack Hub 是用于部署 Kubernetes 应用程序的平台和结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-340">Azure Stack Hub is the platform and fabric on which Kubernetes applications will be deployed.</span></span> <span data-ttu-id="fb654-341">Kubernetes 应用程序的应用程序所有者将是 Azure Stack Hub 的用户，该用户有权部署解决方案所需的应用程序基础结构。</span><span class="sxs-lookup"><span data-stu-id="fb654-341">The application owner for the Kubernetes application will be a user of Azure Stack Hub, with access granted to deploy the application infrastructure needed for the solution.</span></span> <span data-ttu-id="fb654-342">本例中的应用程序基础结构是指使用 AKS 引擎部署的 Kubernetes 群集以及周边服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-342">Application infrastructure in this case means the Kubernetes cluster, deployed using AKS Engine, and the surrounding services.</span></span> <span data-ttu-id="fb654-343">这些组件将部署到 Azure Stack Hub，受 Azure Stack Hub 产品/服务的约束。</span><span class="sxs-lookup"><span data-stu-id="fb654-343">These components will be deployed into Azure Stack Hub, constrained by an Azure Stack Hub offer.</span></span> <span data-ttu-id="fb654-344">确保 Kubernetes 应用程序所有者接受的产品/服务具有足够的容量（以 Azure Stack Hub 配额表示）来部署整个解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-344">Make sure the offer accepted by the Kubernetes application owner has sufficient capacity (expressed in Azure Stack Hub quotas) to deploy the entire solution.</span></span> <span data-ttu-id="fb654-345">前一部分中给出了建议，应使用基础结构即代码和 Azure DevOps Azure Pipelines 等部署管道来自动进行应用程序部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-345">As recommended in the previous section, the application deployment should be automated using Infrastructure-as-Code and deployment pipelines like Azure DevOps Azure Pipelines.</span></span>

<span data-ttu-id="fb654-346">有关 Azure Stack Hub 产品/服务和配额的详细信息，请参阅 [Azure Stack Hub 服务、计划、产品/服务和订阅概述](/azure-stack/operator/service-plan-offer-subscription-overview)</span><span class="sxs-lookup"><span data-stu-id="fb654-346">For more information on Azure Stack Hub offers and quotas, see [Azure Stack Hub services, plans, offers, and subscriptions overview](/azure-stack/operator/service-plan-offer-subscription-overview)</span></span>

<span data-ttu-id="fb654-347">务必安全地保存并存储 AKS 引擎配置，包括其输出。</span><span class="sxs-lookup"><span data-stu-id="fb654-347">It's important to securely save and store the AKS Engine configuration including its outputs.</span></span> <span data-ttu-id="fb654-348">这些文件包含用于访问 Kubernetes 群集的机密信息，因此必须对其进行保护，以免向非管理员公开。</span><span class="sxs-lookup"><span data-stu-id="fb654-348">These files contain confidential information used to access the Kubernetes cluster, so it must be protected from being exposed to non-administrators.</span></span>

<span data-ttu-id="fb654-349">**应用程序可用性**</span><span class="sxs-lookup"><span data-stu-id="fb654-349">**Application availability**</span></span>

<span data-ttu-id="fb654-350">应用程序不应依赖于已部署实例的备份。</span><span class="sxs-lookup"><span data-stu-id="fb654-350">The application shouldn't rely on backups of a deployed instance.</span></span> <span data-ttu-id="fb654-351">作为标准做法，请完全按照基础结构即代码模式重新部署应用程序。</span><span class="sxs-lookup"><span data-stu-id="fb654-351">As a standard practice, redeploy the application completely following Infrastructure-as-Code patterns.</span></span> <span data-ttu-id="fb654-352">例如，使用 Azure DevOps Azure Pipelines 重新部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-352">For example, redeploy using Azure DevOps Azure Pipelines.</span></span> <span data-ttu-id="fb654-353">BCDR 过程应包括将应用程序重新部署到同一个或另一个 Kubernetes 群集。</span><span class="sxs-lookup"><span data-stu-id="fb654-353">The BCDR procedure should involve the redeployment of the application to the same or another Kubernetes cluster.</span></span>

<span data-ttu-id="fb654-354">**应用程序数据**</span><span class="sxs-lookup"><span data-stu-id="fb654-354">**Application data**</span></span>

<span data-ttu-id="fb654-355">应用程序数据是最大程度减少数据丢失的关键部分。</span><span class="sxs-lookup"><span data-stu-id="fb654-355">Application data is the critical part to minimize data loss.</span></span> <span data-ttu-id="fb654-356">前一部分介绍了在应用程序的两个（或多个）实例之间复制和同步数据的技术。</span><span class="sxs-lookup"><span data-stu-id="fb654-356">In the previous section, techniques to replicate and synchronize data between two (or more) instances of the application were described.</span></span> <span data-ttu-id="fb654-357">根据用于存储数据的数据库基础结构（MySQL、MongoDB、MSSQL 或其他），将有不同的数据库可用性和备份技术可供选择。</span><span class="sxs-lookup"><span data-stu-id="fb654-357">Depending on the database infrastructure (MySQL, MongoDB, MSSQL or others) used to store the data, there will be different database availability and backup techniques available to choose from.</span></span>

<span data-ttu-id="fb654-358">为实现完整性，建议使用以下其中一种方法：</span><span class="sxs-lookup"><span data-stu-id="fb654-358">The recommended ways to achieve integrity are to use either:</span></span>
- <span data-ttu-id="fb654-359">特定数据库的原生备份解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-359">A native backup solution for the specific database.</span></span>
- <span data-ttu-id="fb654-360">正式支持备份和恢复应用程序使用的数据库类型的备份解决方案。</span><span class="sxs-lookup"><span data-stu-id="fb654-360">A backup solution that officially supports backup and recovery of the database type used by your application.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="fb654-361">不要将备份数据存储在应用程序数据所在的同一 Azure Stack Hub 实例上。</span><span class="sxs-lookup"><span data-stu-id="fb654-361">Do not store your backup data on the same Azure Stack Hub instance where your application data resides.</span></span> <span data-ttu-id="fb654-362">Azure Stack Hub 实例的完全中断也将损害你的备份。</span><span class="sxs-lookup"><span data-stu-id="fb654-362">A complete outage of the Azure Stack Hub instance would also compromise your backups.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="fb654-363">可用性注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-363">Availability considerations</span></span>

<span data-ttu-id="fb654-364">通过 AKS 引擎部署的 Azure Stack Hub 上的 Kubernetes 不是托管服务，</span><span class="sxs-lookup"><span data-stu-id="fb654-364">Kubernetes on Azure Stack Hub deployed via AKS Engine isn't a managed service.</span></span> <span data-ttu-id="fb654-365">而是使用 Azure 基础结构即服务 (IaaS) 的 Kubernetes 群集的自动部署和配置。</span><span class="sxs-lookup"><span data-stu-id="fb654-365">It's an automated deployment and configuration of a Kubernetes cluster using Azure Infrastructure-as-a-Service (IaaS).</span></span> <span data-ttu-id="fb654-366">因此，它提供与基础结构相同的可用性。</span><span class="sxs-lookup"><span data-stu-id="fb654-366">As such, it provides the same availability as the underlying infrastructure.</span></span>

<span data-ttu-id="fb654-367">Azure Stack Hub 基础结构已具备从故障种恢复的能力，并提供了可用性集等功能，可以跨多个[容错域和更新域](/azure-stack/user/azure-stack-vm-considerations#high-availability)分布组件。</span><span class="sxs-lookup"><span data-stu-id="fb654-367">Azure Stack Hub infrastructure is already resilient to failures, and provides capabilities like Availability Sets to distribute components across multiple [fault and update domains](/azure-stack/user/azure-stack-vm-considerations#high-availability).</span></span> <span data-ttu-id="fb654-368">但是，如果出现硬件故障，底层技术（故障转移群集）仍然会导致受影响物理服务器上的 VM 发生故障。</span><span class="sxs-lookup"><span data-stu-id="fb654-368">But the underlying technology (failover clustering) still incurs some downtime for VMs on an impacted physical server, if there's a hardware failure.</span></span>

<span data-ttu-id="fb654-369">最好将生产 Kubernetes 群集和工作负载部署到两个（或多个）群集。</span><span class="sxs-lookup"><span data-stu-id="fb654-369">It's a good practice to deploy your production Kubernetes cluster as well as the workload to two (or more) clusters.</span></span> <span data-ttu-id="fb654-370">这些群集应托管在不同的位置或数据中心，并使用 Azure 流量管理器等技术根据群集响应时间或地理位置来路由用户。</span><span class="sxs-lookup"><span data-stu-id="fb654-370">These clusters should be hosted in different locations or datacenters, and use technologies like Azure Traffic Manager to route users based on cluster response time or based on geography.</span></span>

![使用流量管理器控制流量流](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager.png)

<span data-ttu-id="fb654-372">拥有单个 Kubernetes 群集的客户通常连接到给定应用程序的服务 IP 或 DNS 名称。</span><span class="sxs-lookup"><span data-stu-id="fb654-372">Customers who have a single Kubernetes cluster typically connect to the service IP or DNS name of a given application.</span></span> <span data-ttu-id="fb654-373">在多群集部署中，客户应连接到指向每个 Kubernetes 群集上的服务/流入量的流量管理器 DNS 名称。</span><span class="sxs-lookup"><span data-stu-id="fb654-373">In a multi-cluster deployment, customers should connect to a Traffic Manager DNS name that points to the services/ingress on each Kubernetes cluster.</span></span>

![使用流量管理器路由到本地群集](media/pattern-highly-available-kubernetes/aks-azure-traffic-manager-on-premises.png)

> [!NOTE]
> <span data-ttu-id="fb654-375">这种模式也是 [适用于 Azure 中（托管）AKS 群集的最佳做法](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment)。</span><span class="sxs-lookup"><span data-stu-id="fb654-375">This pattern is also a [best practice for (managed) AKS clusters in Azure](/azure/aks/operator-best-practices-multi-region#plan-for-multiregion-deployment).</span></span>

<span data-ttu-id="fb654-376">通过 AKS 引擎部署的 Kubernetes 群集本身应至少包含三个主节点和两个工作器节点。</span><span class="sxs-lookup"><span data-stu-id="fb654-376">The Kubernetes cluster itself, deployed via AKS Engine, should consist of at least three master nodes and two worker nodes.</span></span>

## <a name="identity-and-security-considerations"></a><span data-ttu-id="fb654-377">标识和安全注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-377">Identity and security considerations</span></span>

<span data-ttu-id="fb654-378">标识和安全是重要的主题。</span><span class="sxs-lookup"><span data-stu-id="fb654-378">Identity and security are important topics.</span></span> <span data-ttu-id="fb654-379">尤其是在解决方案跨越独立的 Azure Stack Hub 实例这种情况下。</span><span class="sxs-lookup"><span data-stu-id="fb654-379">Especially when the solution spans independent Azure Stack Hub instances.</span></span> <span data-ttu-id="fb654-380">Kubernetes 和 Azure（包括 Azure Stack Hub）都提供不同的基于角色的访问控制 (RBAC) 机制：</span><span class="sxs-lookup"><span data-stu-id="fb654-380">Kubernetes and Azure (including Azure Stack Hub) both have distinct mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="fb654-381">Azure RBAC 控制对 Azure（和 Azure Stack Hub）中的资源的访问，还可以创建新的 Azure 资源。</span><span class="sxs-lookup"><span data-stu-id="fb654-381">Azure RBAC controls access to resources in Azure (and Azure Stack Hub), including the ability to create new Azure resources.</span></span> <span data-ttu-id="fb654-382">可将权限分配给用户、组或服务主体。</span><span class="sxs-lookup"><span data-stu-id="fb654-382">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="fb654-383">（服务主体是应用程序使用的安全标识。）</span><span class="sxs-lookup"><span data-stu-id="fb654-383">(A service principal is a security identity used by applications.)</span></span>
- <span data-ttu-id="fb654-384">Kubernetes RBAC 控制 Kubernetes API 的权限。</span><span class="sxs-lookup"><span data-stu-id="fb654-384">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="fb654-385">例如，可以通过 RBAC 授权（或拒绝）用户执行创建 pod 和列出 pod 的操作。</span><span class="sxs-lookup"><span data-stu-id="fb654-385">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="fb654-386">若要将 Kubernetes 权限分配给用户，请创建角色和角色绑定。</span><span class="sxs-lookup"><span data-stu-id="fb654-386">To assign Kubernetes permissions to users, you create roles and role bindings.</span></span>

<span data-ttu-id="fb654-387">**Azure Stack Hub 标识和 RBAC**</span><span class="sxs-lookup"><span data-stu-id="fb654-387">**Azure Stack Hub identity and RBAC**</span></span>

<span data-ttu-id="fb654-388">Azure Stack Hub 提供两个标识提供者选项。</span><span class="sxs-lookup"><span data-stu-id="fb654-388">Azure Stack Hub provides two identity provider choices.</span></span> <span data-ttu-id="fb654-389">你使用的提供程序依赖于环境以及是在已联网还是断开网络连接的环境中运行：</span><span class="sxs-lookup"><span data-stu-id="fb654-389">The provider you use depends on the environment and whether running in a connected or disconnected environment:</span></span>

- <span data-ttu-id="fb654-390">Azure AD - 只能在连接的环境中使用。</span><span class="sxs-lookup"><span data-stu-id="fb654-390">Azure AD - can only be used in a connected environment.</span></span>
- <span data-ttu-id="fb654-391">ADFS 到传统 Active Directory 林 - 可用于已联网还是断开网络连接的环境。</span><span class="sxs-lookup"><span data-stu-id="fb654-391">ADFS to a traditional Active Directory forest - can be used in both a connected or disconnected environment.</span></span>

<span data-ttu-id="fb654-392">标识提供程序管理用户和组，包括用于访问资源的身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="fb654-392">The identity provider manages users and groups, including authentication and authorization for accessing resources.</span></span> <span data-ttu-id="fb654-393">可以授予对 Azure Stack Hub 资源（如订阅、资源组）和单个资源（如 VM 或负载均衡器）的访问权限。</span><span class="sxs-lookup"><span data-stu-id="fb654-393">Access can be granted to Azure Stack Hub resources like subscriptions, resource groups, and individual resources like VMs or load balancers.</span></span> <span data-ttu-id="fb654-394">若要获得一致的访问模型，应考虑对所有 Azure Stack Hub 使用相同的组（直接或嵌套）。</span><span class="sxs-lookup"><span data-stu-id="fb654-394">To have a consistent access model, you should consider using the same groups (either direct or nested) for all Azure Stack Hubs.</span></span> <span data-ttu-id="fb654-395">下面是一个配置示例：</span><span class="sxs-lookup"><span data-stu-id="fb654-395">Here's a configuration example:</span></span>

![Azure Stack Hub 的嵌套 AAD 组](media/pattern-highly-available-kubernetes/azure-stack-azure-ad-nested-groups.png)

<span data-ttu-id="fb654-397">该示例包含一个有特定用途的专用组（使用 AAD 或 ADFS）。</span><span class="sxs-lookup"><span data-stu-id="fb654-397">The example contains a dedicated group (using AAD or ADFS) for a specific purpose.</span></span> <span data-ttu-id="fb654-398">例如，在特定的 Azure Stack Hub 实例上为包含 Kubernetes 群集基础结构的资源组提供参与者权限（此处为“Seattle K8s 群集参与者”）。</span><span class="sxs-lookup"><span data-stu-id="fb654-398">For example, to provide Contributor permissions for the Resource Group that contains our Kubernetes cluster infrastructure on a specific Azure Stack Hub instance (here "Seattle K8s Cluster Contributor").</span></span> <span data-ttu-id="fb654-399">然后，这些组嵌套到一个整体组中，该组包含每个 Azure Stack Hub 的“子组”。</span><span class="sxs-lookup"><span data-stu-id="fb654-399">These groups are then nested into an overall group that contains the "subgroups" for each Azure Stack Hub.</span></span>

<span data-ttu-id="fb654-400">我们的示例用户现在将具有对包含整个 Kubernetes 基础结构资源集的两个资源组的“参与者”权限。</span><span class="sxs-lookup"><span data-stu-id="fb654-400">Our sample user will now have "Contributor" permissions to both Resources Groups that contain the entire set of Kubernetes infrastructure resources.</span></span> <span data-ttu-id="fb654-401">由于实例共用同一标识提供者，因此用户可以访问这两个 Azure Stack Hub 实例上的资源。</span><span class="sxs-lookup"><span data-stu-id="fb654-401">The user will have access to resources on both Azure Stack Hub instances, because the instances share the same identity provider.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="fb654-402">这些权限只会影响 Azure Stack Hub 和在其基础上部署的一些资源。</span><span class="sxs-lookup"><span data-stu-id="fb654-402">These permissions affect only Azure Stack Hub and some of the resources deployed on top of it.</span></span> <span data-ttu-id="fb654-403">具有这种访问级别的用户可能会造成很多损害，但如果没有对 Kubernetes 部署的更多访问权限，则无法访问 Kubernetes IaaS VM 或 Kubernetes API。</span><span class="sxs-lookup"><span data-stu-id="fb654-403">A user who has this level of access can do a lot of harm, but cannot access the Kubernetes IaaS VMs nor the Kubernetes API without additional access to the Kubernetes deployment.</span></span>

<span data-ttu-id="fb654-404">**Kubernetes 标识和 RBAC**</span><span class="sxs-lookup"><span data-stu-id="fb654-404">**Kubernetes identity and RBAC**</span></span>

<span data-ttu-id="fb654-405">默认情况下，Kubernetes 群集使用的标识提供者与基础 Azure Stack Hub 使用的不同。</span><span class="sxs-lookup"><span data-stu-id="fb654-405">A Kubernetes cluster, by default, doesn't use the same Identity Provider as the underlaying Azure Stack Hub.</span></span> <span data-ttu-id="fb654-406">托管 Kubernetes 群集、主节点和工作器节点的 VM 使用在群集部署期间指定的 SSH 密钥。</span><span class="sxs-lookup"><span data-stu-id="fb654-406">The VMs hosting the Kubernetes cluster, the master, and worker nodes, use the SSH Key that is specified during the deployment of the cluster.</span></span> <span data-ttu-id="fb654-407">使用 SSH 连接到这些节点需要此 SSH 密钥。</span><span class="sxs-lookup"><span data-stu-id="fb654-407">This SSH key is required to connect to these nodes using SSH.</span></span>

<span data-ttu-id="fb654-408">Kubernetes API（例如使用 `kubectl` 进行访问）还受到服务帐户（包括默认的“群集管理员”服务帐户）的保护。</span><span class="sxs-lookup"><span data-stu-id="fb654-408">The Kubernetes API (for example, accessed by using `kubectl`) is also protected by service accounts including a default "cluster admin" service account.</span></span> <span data-ttu-id="fb654-409">此服务帐户的凭据最初存储在 Kubernetes 主节点上的 `.kube/config` 文件中。</span><span class="sxs-lookup"><span data-stu-id="fb654-409">The credentials for this service account are initially stored in the `.kube/config` file on your Kubernetes master nodes.</span></span>

<span data-ttu-id="fb654-410">**机密管理和应用程序凭据**</span><span class="sxs-lookup"><span data-stu-id="fb654-410">**Secrets management and application credentials**</span></span>

<span data-ttu-id="fb654-411">若要存储机密（如连接字符串或数据库凭据），有多种选择，包括：</span><span class="sxs-lookup"><span data-stu-id="fb654-411">To store secrets like connection strings or database credentials there are several choices, including:</span></span>

- <span data-ttu-id="fb654-412">Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="fb654-412">Azure Key Vault</span></span>
- <span data-ttu-id="fb654-413">Kubernetes 机密</span><span class="sxs-lookup"><span data-stu-id="fb654-413">Kubernetes Secrets</span></span>
- <span data-ttu-id="fb654-414">第三方解决方案，如 HashiCorp Vault（在 Kubernetes 上运行）</span><span class="sxs-lookup"><span data-stu-id="fb654-414">3rd-Party solutions like HashiCorp Vault (running on Kubernetes)</span></span>

<span data-ttu-id="fb654-415">请勿在配置文件、应用程序代码或脚本中以明文形式存储机密或凭据。</span><span class="sxs-lookup"><span data-stu-id="fb654-415">Do not store secrets or credentials in plaintext in your configuration files, application code, or within scripts.</span></span> <span data-ttu-id="fb654-416">并且不要将其存储在版本控制系统中。</span><span class="sxs-lookup"><span data-stu-id="fb654-416">And do not store them in a version control system.</span></span> <span data-ttu-id="fb654-417">而应该让部署自动化根据需要检索机密。</span><span class="sxs-lookup"><span data-stu-id="fb654-417">Instead, the deployment automation should retrieve the secrets as needed.</span></span>

## <a name="patch-and-update"></a><span data-ttu-id="fb654-418">修补和更新</span><span class="sxs-lookup"><span data-stu-id="fb654-418">Patch and update</span></span>

<span data-ttu-id="fb654-419">Azure Kubernetes 服务中的修补程序和更新 (PNU) 过程是部分自动化的。</span><span class="sxs-lookup"><span data-stu-id="fb654-419">The **Patch and Update (PNU)** process in Azure Kubernetes Service is partially automated.</span></span> <span data-ttu-id="fb654-420">Kubernetes 版本升级是手动触发的，而安全更新是自动应用的。</span><span class="sxs-lookup"><span data-stu-id="fb654-420">Kubernetes version upgrades are triggered manually, while security updates are applied automatically.</span></span> <span data-ttu-id="fb654-421">这些更新可能包括 OS 安全修复项或内核更新。</span><span class="sxs-lookup"><span data-stu-id="fb654-421">These updates can include OS security fixes or kernel updates.</span></span> <span data-ttu-id="fb654-422">AKS 不会自动重启这些 Linux 节点以完成更新进程。</span><span class="sxs-lookup"><span data-stu-id="fb654-422">AKS doesn't automatically reboot these Linux nodes to complete the update process.</span></span> 

<span data-ttu-id="fb654-423">使用 Azure Stack Hub 上的 AKS 引擎部署的 Kubernetes 群集的 PNU 流程不受管理，并且由群集操作员负责。</span><span class="sxs-lookup"><span data-stu-id="fb654-423">The PNU process for a Kubernetes cluster deployed using AKS Engine on Azure Stack Hub is unmanaged, and is the responsibility of the cluster operator.</span></span> 

<span data-ttu-id="fb654-424">AKS 引擎有助于执行两个最重要的任务：</span><span class="sxs-lookup"><span data-stu-id="fb654-424">AKS Engine helps with the two most important tasks:</span></span>

- [<span data-ttu-id="fb654-425">升级到较新的 Kubernetes 和基础 OS 映像版本</span><span class="sxs-lookup"><span data-stu-id="fb654-425">Upgrade to a newer Kubernetes and base OS image version</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-upgrade-to-a-newer-kubernetes-version)
- [<span data-ttu-id="fb654-426">仅升级基础 OS 映像</span><span class="sxs-lookup"><span data-stu-id="fb654-426">Upgrade the base OS image only</span></span>](/azure-stack/user/azure-stack-kubernetes-aks-engine-upgrade#steps-to-only-upgrade-the-os-image)

<span data-ttu-id="fb654-427">较新的基础 OS 映像包含最新 OS 安全修补程序和内核更新。</span><span class="sxs-lookup"><span data-stu-id="fb654-427">Newer base OS images contain the latest OS security fixes and kernel updates.</span></span> 

<span data-ttu-id="fb654-428">[无人参与升级](https://wiki.debian.org/UnattendedUpgrades)机制会自动安装在 Azure Stack Hub 市场提供新基础 OS 映像版本之前发布的安全更新。</span><span class="sxs-lookup"><span data-stu-id="fb654-428">The [Unattended Upgrade](https://wiki.debian.org/UnattendedUpgrades) mechanism automatically installs security updates that are released before a new base OS image version is available in the Azure Stack Hub Marketplace.</span></span> <span data-ttu-id="fb654-429">默认情况下会启用无人参与升级，并自动安装安全更新，但不重启 Kubernetes 群集节点。</span><span class="sxs-lookup"><span data-stu-id="fb654-429">Unattended upgrade is enabled by default and installs security updates automatically, but does not reboot the Kubernetes cluster nodes.</span></span> <span data-ttu-id="fb654-430">可以使用开源 [KUbernetes REboot Daemon (kured)](/azure/aks/node-updates-kured) 自动重启节点  。</span><span class="sxs-lookup"><span data-stu-id="fb654-430">Rebooting the nodes can be automated using the open-source [**K** Ubernetes **RE** boot **D** aemon (kured))](/azure/aks/node-updates-kured).</span></span> <span data-ttu-id="fb654-431">Kured 监视需要重启的 Linux 节点，然后自动处理正在运行的 Pod 和节点重启过程的重新安排。</span><span class="sxs-lookup"><span data-stu-id="fb654-431">Kured watches for Linux nodes that require a reboot, then automatically handle the rescheduling of running pods and node reboot process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="fb654-432">部署 (CI/CD) 注意事项</span><span class="sxs-lookup"><span data-stu-id="fb654-432">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="fb654-433">Azure 和 Azure Stack Hub 公开相同的 Azure 资源管理器 REST API。</span><span class="sxs-lookup"><span data-stu-id="fb654-433">Azure and Azure Stack Hub expose the same Azure Resource Manager REST APIs.</span></span> <span data-ttu-id="fb654-434">这些 API 的处理方式与其他任何 Azure 云（Azure、Azure 中国世纪互联、Azure 政府）相同。</span><span class="sxs-lookup"><span data-stu-id="fb654-434">These APIs are addressed like any other Azure cloud (Azure, Azure China 21Vianet, Azure Government).</span></span> <span data-ttu-id="fb654-435">不同云之间的 API 版本可能有所不同，Azure Stack Hub 仅提供一部分服务。</span><span class="sxs-lookup"><span data-stu-id="fb654-435">There may be differences in API versions between clouds, and Azure Stack Hub provides only a subset of services.</span></span> <span data-ttu-id="fb654-436">每个云以及 Azure Stack Hub 的每个实例的管理终结点 URI 也不同。</span><span class="sxs-lookup"><span data-stu-id="fb654-436">The management endpoint URI is also different for each cloud, and each instance of Azure Stack Hub.</span></span>

<span data-ttu-id="fb654-437">除了提到的细微差异外，Azure 资源管理器 REST API 提供了一种一致的方法来与 Azure 和 Azure Stack Hub 交互。</span><span class="sxs-lookup"><span data-stu-id="fb654-437">Aside from the subtle differences mentioned, Azure Resource Manager REST APIs provide a consistent way to interact with both Azure and Azure Stack Hub.</span></span> <span data-ttu-id="fb654-438">这里可以使用的工具集与任何其他 Azure 云要使用的相同。</span><span class="sxs-lookup"><span data-stu-id="fb654-438">The same set of tools can be used here as would be used with any other Azure cloud.</span></span> <span data-ttu-id="fb654-439">可以使用 Azure DevOps、Jenkins 等工具或 PowerShell 将服务部署和编排到 Azure Stack Hub。</span><span class="sxs-lookup"><span data-stu-id="fb654-439">You can use Azure DevOps, tools like Jenkins, or PowerShell, to deploy and orchestrate services to Azure Stack Hub.</span></span>

<span data-ttu-id="fb654-440">**注意事项**</span><span class="sxs-lookup"><span data-stu-id="fb654-440">**Considerations**</span></span>

<span data-ttu-id="fb654-441">在 Azure Stack Hub 部署方面，一个主要区别是 Internet 可访问性问题。</span><span class="sxs-lookup"><span data-stu-id="fb654-441">One of the major differences when it comes to Azure Stack Hub deployments is the question of Internet accessibility.</span></span> <span data-ttu-id="fb654-442">Internet 可访问性决定是否为 CI/CD 作业选择 Microsoft 托管的生成代理或自托管生成代理。</span><span class="sxs-lookup"><span data-stu-id="fb654-442">Internet accessibility determines whether to select a Microsoft-hosted or a self-hosted build agent for your CI/CD jobs.</span></span>

<span data-ttu-id="fb654-443">自托管代理可以在 Azure Stack Hub 上运行（作为 IaaS VM），也可以在可以访问 Azure Stack Hub 的网络子网中运行。</span><span class="sxs-lookup"><span data-stu-id="fb654-443">A self-hosted agent can run on top of Azure Stack Hub (as an IaaS VM) or in a network subnet that can access Azure Stack Hub.</span></span> <span data-ttu-id="fb654-444">请转到 [Azure Pipelines 代理](/azure/devops/pipelines/agents/agents)，了解相关差异的详细信息。</span><span class="sxs-lookup"><span data-stu-id="fb654-444">Go to [Azure Pipelines agents](/azure/devops/pipelines/agents/agents) to learn more about the differences.</span></span>

<span data-ttu-id="fb654-445">下图可帮助你决定是需要自托管生成代理还是 Microsoft 托管的生成代理：</span><span class="sxs-lookup"><span data-stu-id="fb654-445">The following image helps you to decide if you need a self-hosted or a Microsoft-hosted build agent:</span></span>

![自托管生成代理“是”或“否”](media/pattern-highly-available-kubernetes/aks-on-stack-self-hosted-build-agents-yes-or-no.png)

- <span data-ttu-id="fb654-447">Azure Stack Hub 管理终结点是否可通过 Internet 访问？</span><span class="sxs-lookup"><span data-stu-id="fb654-447">Are the Azure Stack Hub management endpoints accessible via Internet?</span></span>
  - <span data-ttu-id="fb654-448">是：我们可以将 Azure Pipelines 与 Microsoft 托管的代理结合使用，以连接到 Azure Stack Hub。</span><span class="sxs-lookup"><span data-stu-id="fb654-448">Yes: We can use Azure Pipelines with Microsoft-hosted agents to connect to Azure Stack Hub.</span></span>
  - <span data-ttu-id="fb654-449">否：我们需要可连接到 Azure Stack Hub 管理终结点的自托管代理。</span><span class="sxs-lookup"><span data-stu-id="fb654-449">No: We need self-hosted agents that can connect to Azure Stack Hub's management endpoints.</span></span>
- <span data-ttu-id="fb654-450">我们的 Kubernetes 群集是否可通过 Internet 访问？</span><span class="sxs-lookup"><span data-stu-id="fb654-450">Is our Kubernetes cluster accessible via the Internet?</span></span>
  - <span data-ttu-id="fb654-451">是：我们可以将 Azure Pipelines 与 Microsoft 托管的代理结合使用，以直接与 Kubernetes API 终结点进行交互。</span><span class="sxs-lookup"><span data-stu-id="fb654-451">Yes: We can use Azure Pipelines with Microsoft-hosted agents to interact directly with Kubernetes API endpoint.</span></span>
  - <span data-ttu-id="fb654-452">否：我们需要可连接到 Kubernetes 群集 API 终结点的自托管代理。</span><span class="sxs-lookup"><span data-stu-id="fb654-452">No: We need self-hosted Agents that can connect to the Kubernetes cluster API endpoint.</span></span>

<span data-ttu-id="fb654-453">在可以通过 Internet 访问 Azure Stack Hub 管理终结点和 Kubernetes API 的情况下，部署可以使用 Microsoft 托管的代理。</span><span class="sxs-lookup"><span data-stu-id="fb654-453">In scenarios where the Azure Stack Hub management endpoints and Kubernetes API are accessible via the internet, the deployment can use a Microsoft-hosted agent.</span></span> <span data-ttu-id="fb654-454">这一部署将产生如下的应用程序体系结构：</span><span class="sxs-lookup"><span data-stu-id="fb654-454">This deployment will result in an application architecture as follows:</span></span>

<span data-ttu-id="fb654-455">[![公共体系结构概述](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="fb654-455">[![Public architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern.png#lightbox)</span></span>

<span data-ttu-id="fb654-456">如果无法通过 Internet 直接访问 Azure 资源管理器终结点、Kubernetes API 或这两者，则可以利用自托管生成代理来运行管道步骤。</span><span class="sxs-lookup"><span data-stu-id="fb654-456">If the Azure Resource Manager endpoints, Kubernetes API, or both aren't directly accessible via the Internet, we can leverage a self-hosted build agent to run the pipeline steps.</span></span> <span data-ttu-id="fb654-457">此设计需要较少的连接，并且可以仅通过与 Azure 资源管理器终结点和 Kubernetes API 的本地网络连接进行部署：</span><span class="sxs-lookup"><span data-stu-id="fb654-457">This design needs less connectivity, and can be deployed with only on-premises network connectivity to Azure Resource Manager endpoints and the Kubernetes API:</span></span>

<span data-ttu-id="fb654-458">[![本地体系结构概述](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span><span class="sxs-lookup"><span data-stu-id="fb654-458">[![On-prem architecture overview](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png)](media/pattern-highly-available-kubernetes/aks-azure-stack-app-pattern-self-hosted.png#lightbox)</span></span>

> [!NOTE]
> <span data-ttu-id="fb654-459">已断开连接的场景如何？</span><span class="sxs-lookup"><span data-stu-id="fb654-459">**What about disconnected scenarios?**</span></span> <span data-ttu-id="fb654-460">在 Azure Stack Hub、Kubernetes 或两者都没有面向 Internet 的管理终结点这种情况下，仍然可以使用 Azure DevOps 进行部署。</span><span class="sxs-lookup"><span data-stu-id="fb654-460">In scenarios where either Azure Stack Hub or Kubernetes or both of them do not have internet-facing management endpoints, it is still possible to use Azure DevOps for your deployments.</span></span> <span data-ttu-id="fb654-461">可以在本地使用自托管的代理池（这是在本地或在 Azure Stack Hub 自身上运行的 DevOps 代理），也可以使用完全自托管的 Azure DevOps Server。</span><span class="sxs-lookup"><span data-stu-id="fb654-461">You can either use a self-hosted Agent Pool (which is a DevOps Agent running on-premises or on Azure Stack Hub itself) or a completly self-hosted Azure DevOps Server on-premises.</span></span> <span data-ttu-id="fb654-462">自托管代理只需要出站 HTTPS (TCP/443) Internet 连接。</span><span class="sxs-lookup"><span data-stu-id="fb654-462">The self-hosted agent needs only outbound HTTPS (TCP/443) Internet connectivity.</span></span>

<span data-ttu-id="fb654-463">该模式可以在每个 Azure Stack Hub 实例上使用 Kubernetes 群集（使用 AKS 引擎进行部署和协调）。</span><span class="sxs-lookup"><span data-stu-id="fb654-463">The pattern can use a Kubernetes cluster (deployed and orchestrated with AKS engine) on each Azure Stack Hub instance.</span></span> <span data-ttu-id="fb654-464">其中包括一个由前端、中间层、后端服务（例如 MongoDB）和基于 Nginx 的入口控制器组成的应用程序。</span><span class="sxs-lookup"><span data-stu-id="fb654-464">It includes an application consisting of a frontend, a mid-tier, backend services (for example MongoDB), and an nginx-based Ingress Controller.</span></span> <span data-ttu-id="fb654-465">可以使用“外部数据存储”，而不是使用 K8s 群集上托管的数据库。</span><span class="sxs-lookup"><span data-stu-id="fb654-465">Instead of using a database hosted on the K8s cluster, you can leverage "external data stores".</span></span> <span data-ttu-id="fb654-466">数据库选项包括 MySQL、SQL Server 或 Azure Stack Hub 之外或 IaaS 中托管的任何类型的数据库。</span><span class="sxs-lookup"><span data-stu-id="fb654-466">Database options include MySQL, SQL Server, or any kind of database hosted outside of Azure Stack Hub or in IaaS.</span></span> <span data-ttu-id="fb654-467">此类配置不在本文范围内。</span><span class="sxs-lookup"><span data-stu-id="fb654-467">Configurations like this aren't in scope here.</span></span>

## <a name="partner-solutions"></a><span data-ttu-id="fb654-468">合作伙伴解决方案</span><span class="sxs-lookup"><span data-stu-id="fb654-468">Partner solutions</span></span>

<span data-ttu-id="fb654-469">有一些 Microsoft 合作伙伴解决方案可以拓展 Azure Stack Hub 的功能。</span><span class="sxs-lookup"><span data-stu-id="fb654-469">There are Microsoft Partner solutions that can extend the capabilities of Azure Stack Hub.</span></span> <span data-ttu-id="fb654-470">这些解决方案在部署 Kubernetes 群集上运行的应用程序时很有用。</span><span class="sxs-lookup"><span data-stu-id="fb654-470">These solutions have been found useful in deployments of applications running on Kubernetes clusters.</span></span>  

## <a name="storage-and-data-solutions"></a><span data-ttu-id="fb654-471">存储和数据解决方案</span><span class="sxs-lookup"><span data-stu-id="fb654-471">Storage and data solutions</span></span>

<span data-ttu-id="fb654-472">如[数据和存储注意事项](#data-and-storage-considerations)中所述，Azure Stack Hub 当前没有原生解决方案来跨多个实例复制存储。</span><span class="sxs-lookup"><span data-stu-id="fb654-472">As described in [Data and storage considerations](#data-and-storage-considerations), Azure Stack Hub currently doesn't have a native solution to replicate storage across multiple instances.</span></span> <span data-ttu-id="fb654-473">与 Azure 不同，Azure Stack Hub 并没有跨多个区域复制存储的功能。</span><span class="sxs-lookup"><span data-stu-id="fb654-473">Unlike Azure, the capability of replicating storage across multiple regions does not exist.</span></span> <span data-ttu-id="fb654-474">在 Azure Stack Hub 中，每个实例都是其自己独有的云。</span><span class="sxs-lookup"><span data-stu-id="fb654-474">In Azure Stack Hub, each instance is its own distinct cloud.</span></span> <span data-ttu-id="fb654-475">但是，可以从 Microsoft 合作伙伴处获得解决方案，这些解决方案可以跨 Azure Stack Hub 和 Azure 进行存储复制。</span><span class="sxs-lookup"><span data-stu-id="fb654-475">However, solutions are available from Microsoft Partners that enable storage replication across Azure Stack Hubs and Azure.</span></span> 

<span data-ttu-id="fb654-476">**SCALITY**</span><span class="sxs-lookup"><span data-stu-id="fb654-476">**SCALITY**</span></span>

<span data-ttu-id="fb654-477">[Scality](https://www.scality.com/) 提供 Web 规模的存储，自 2009 年以来便为数字业务提供支持。</span><span class="sxs-lookup"><span data-stu-id="fb654-477">[Scality](https://www.scality.com/) delivers web-scale storage that has powered digital businesses since 2009.</span></span> <span data-ttu-id="fb654-478">Scality RING 是我们的软件定义存储，可将商用 x86 服务器转变为无限制的存储池，用于存储 PB 级的任何类型的数据（文件和对象）。</span><span class="sxs-lookup"><span data-stu-id="fb654-478">The Scality RING, our software-defined storage, turns commodity x86 servers into an unlimited storage pool for any type of data –file and object– at petabyte scale.</span></span>

<span data-ttu-id="fb654-479">**CLOUDIAN**</span><span class="sxs-lookup"><span data-stu-id="fb654-479">**CLOUDIAN**</span></span>

<span data-ttu-id="fb654-480">[Cloudian](https://www.cloudian.com/) 通过无限的可缩放存储简化了企业存储，这种可缩放存储会将大量数据集整合到一种易于管理的环境中。</span><span class="sxs-lookup"><span data-stu-id="fb654-480">[Cloudian](https://www.cloudian.com/) simplifies enterprise storage with limitless scalable storage that consolidates massive data sets to a single, easily managed environment.</span></span>

## <a name="next-steps"></a><span data-ttu-id="fb654-481">后续步骤</span><span class="sxs-lookup"><span data-stu-id="fb654-481">Next steps</span></span>

<span data-ttu-id="fb654-482">若要详细了解本文介绍的概念，请参阅：</span><span class="sxs-lookup"><span data-stu-id="fb654-482">To learn more about concepts introduced in this article:</span></span>

- <span data-ttu-id="fb654-483">Azure Stack Hub 中的[跨云缩放](pattern-cross-cloud-scale.md)和[地理分布式应用模式](pattern-geo-distributed.md)。</span><span class="sxs-lookup"><span data-stu-id="fb654-483">[Cross-cloud scaling](pattern-cross-cloud-scale.md) and [Geo-distributed app patterns](pattern-geo-distributed.md) in Azure Stack Hub.</span></span>
- <span data-ttu-id="fb654-484">[Azure Kubernetes 服务 (AKS) 上的微服务体系结构](/azure/architecture/reference-architectures/microservices/aks)。</span><span class="sxs-lookup"><span data-stu-id="fb654-484">[Microservices architecture on Azure Kubernetes Service (AKS)](/azure/architecture/reference-architectures/microservices/aks).</span></span>

<span data-ttu-id="fb654-485">准备好测试解决方案示例时，请继续学习[高可用性 Kubernetes 群集部署指南](solution-deployment-guide-highly-available-kubernetes.md)。</span><span class="sxs-lookup"><span data-stu-id="fb654-485">When you're ready to test the solution example, continue with the [High availability Kubernetes cluster deployment guide](solution-deployment-guide-highly-available-kubernetes.md).</span></span> <span data-ttu-id="fb654-486">该部署指南逐步说明了如何部署和测试 Azure Stack 的组件。</span><span class="sxs-lookup"><span data-stu-id="fb654-486">The deployment guide provides step-by-step instructions for deploying and testing its components.</span></span>